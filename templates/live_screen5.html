{% extends 'base.html' %}
{% block title %}Ekran Numer 5 - Na Å»ywo{% endblock %}
{% block styles %}
{{ super() }}
<style>
    body {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
    }
    .main-container {
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        padding: 2rem;
    }
    .qr-section {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 20px;
        padding: 3rem;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        text-align: center;
        max-width: 600px;
        width: 100%;
    }
    .qr-section h1 {
        color: #667eea;
        font-size: 2.5rem;
        margin-bottom: 1rem;
    }
    .qr-section .qr-code {
        font-size: 4rem;
        font-weight: bold;
        color: #764ba2;
        letter-spacing: 0.3rem;
        padding: 2rem;
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        border-radius: 15px;
        margin: 2rem 0;
        box-shadow: inset 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    .qr-section .badge-label {
        display: inline-block;
        background: #ff6b6b;
        color: white;
        padding: 0.5rem 1.5rem;
        border-radius: 25px;
        font-size: 1rem;
        margin-bottom: 1rem;
        animation: pulse 2s infinite;
    }
    .qr-section .instructions {
        color: #555;
        font-size: 1.1rem;
        margin-top: 1.5rem;
    }

    /* Sekcja statystyk */
    .statistics-section {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 20px;
        padding: 3rem;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        max-width: 900px;
        width: 100%;
        display: none;
    }
    .statistics-section h2 {
        color: #667eea;
        font-size: 2rem;
        margin-bottom: 1rem;
        text-align: center;
    }
    .statistics-section .question-text {
        color: #333;
        font-size: 1.3rem;
        margin-bottom: 2rem;
        text-align: center;
        font-weight: 600;
    }
    .stat-item {
        margin-bottom: 1.5rem;
    }
    .stat-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
        color: #333;
        font-weight: 600;
    }
    .stat-letter {
        font-size: 1.5rem;
        font-weight: bold;
        margin-right: 0.5rem;
    }
    .stat-text {
        flex: 1;
        margin-right: 1rem;
    }
    .stat-count {
        font-size: 1.2rem;
        color: #667eea;
    }
    .stat-bar-container {
        height: 40px;
        background: #f0f0f0;
        border-radius: 25px;
        overflow: hidden;
        position: relative;
    }
    .stat-bar {
        height: 100%;
        background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
        border-radius: 25px;
        transition: width 1s ease-in-out;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        font-size: 1.1rem;
        min-width: 40px;
    }
    .stat-bar.correct {
        background: linear-gradient(90deg, #51cf66 0%, #37b24d 100%);
    }
    .stat-bar.incorrect {
        background: linear-gradient(90deg, #ff6b6b 0%, #fa5252 100%);
    }
    .stat-bar.no-answer {
        background: linear-gradient(90deg, #868e96 0%, #495057 100%);
    }
    .correct-indicator {
        display: inline-block;
        background: #51cf66;
        color: white;
        padding: 0.2rem 0.8rem;
        border-radius: 15px;
        font-size: 0.9rem;
        margin-left: 0.5rem;
    }

    @keyframes pulse {
        0%, 100% {
            transform: scale(1);
            box-shadow: 0 0 0 0 rgba(255, 107, 107, 0.7);
        }
        50% {
            transform: scale(1.05);
            box-shadow: 0 0 0 10px rgba(255, 107, 107, 0);
        }
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .stat-item {
        animation: fadeIn 0.5s ease-out backwards;
    }

    .stat-item:nth-child(1) { animation-delay: 0.1s; }
    .stat-item:nth-child(2) { animation-delay: 0.2s; }
    .stat-item:nth-child(3) { animation-delay: 0.3s; }
    .stat-item:nth-child(4) { animation-delay: 0.4s; }
    .stat-item:nth-child(5) { animation-delay: 0.5s; }
    .stat-item:nth-child(6) { animation-delay: 0.6s; }
    .stat-item:nth-child(7) { animation-delay: 0.7s; }
    .stat-item:nth-child(8) { animation-delay: 0.8s; }
    .stat-item:nth-child(9) { animation-delay: 0.9s; }
    .stat-item:nth-child(10) { animation-delay: 1.0s; }
    .stat-item:nth-child(11) { animation-delay: 1.1s; }
</style>
{% endblock %}
{% block content %}
<div class="main-container">
    <!-- Sekcja QR Code (domyÅ›lnie widoczna) -->
    <div class="qr-section" id="qr-section">
        <span class="badge-label" id="qr-badge">ðŸ”„ ZAPASOWY KOD</span>
        <h1>DoÅ‚Ä…cz do gry!</h1>
        <p style="color: #555; font-size: 1.2rem;">Skanuj kod QR lub wpisz kod:</p>
        <div class="qr-code" id="qr-code-display">{{ qr_code }}</div>
        <p class="instructions">
            ðŸ“± OtwÃ³rz aparat lub skaner QR w telefonie<br>
            ðŸ”— Lub przejdÅº na stronÄ™ i wpisz kod
        </p>
    </div>

    <!-- Sekcja statystyk (ukryta domyÅ›lnie) -->
    <div class="statistics-section" id="statistics-section">
        <h2>ðŸ“Š Statystyki odpowiedzi</h2>
        <div class="question-text" id="statistics-question-text"></div>
        <div id="statistics-container"></div>
    </div>
</div>
{% endblock %}
{% block scripts %}
{{ super() }}
<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const EVENT_ID = {{ event_id }};
    const socket = io();

    const qrSection = document.getElementById('qr-section');
    const statisticsSection = document.getElementById('statistics-section');
    const qrCodeDisplay = document.getElementById('qr-code-display');
    const qrBadge = document.getElementById('qr-badge');

    // PoÅ‚Ä…cz z WebSocket
    socket.on('connect', () => {
        console.log('âœ… Screen 5 connected to WebSocket');
        socket.emit('join', { event_id: EVENT_ID });
    });

    // NasÅ‚uchuj na aktualizacjÄ™ zapasowego kodu QR
    socket.on('live_backup_qr_updated', (data) => {
        console.log('ðŸ”„ Backup QR code updated:', data.backup_qr_code);
        qrCodeDisplay.textContent = data.backup_qr_code;
        qrBadge.textContent = 'ðŸ”„ ZAPASOWY KOD';
        qrBadge.style.background = '#ff6b6b';

        // PokaÅ¼ QR section, ukryj statystyki
        qrSection.style.display = 'block';
        statisticsSection.style.display = 'none';
    });

    // NasÅ‚uchuj na wyÅ›wietlenie statystyk
    socket.on('live_statistics_show', (data) => {
        console.log('ðŸ“Š Statistics received:', data);
        showStatistics(data);
    });

    // Funkcja wyÅ›wietlania statystyk
    function showStatistics(data) {
        const questionText = document.getElementById('statistics-question-text');
        const statisticsContainer = document.getElementById('statistics-container');

        // Ustaw treÅ›Ä‡ pytania
        questionText.textContent = data.question_text || 'Pytanie';

        // WyczyÅ›Ä‡ poprzednie statystyki
        statisticsContainer.innerHTML = '';

        // Dodaj statystyki dla kaÅ¼dej opcji
        data.statistics.forEach((stat, index) => {
            const statItem = document.createElement('div');
            statItem.className = 'stat-item';
            statItem.style.animationDelay = `${index * 0.1}s`;

            // OkreÅ›l klasÄ™ paska na podstawie poprawnoÅ›ci
            let barClass = 'incorrect';
            if (stat.letter === 'BRAK') {
                barClass = 'no-answer';
            } else if (stat.is_correct) {
                barClass = 'correct';
            }

            statItem.innerHTML = `
                <div class="stat-header">
                    <div>
                        <span class="stat-letter">${stat.letter}:</span>
                        <span class="stat-text">${stat.text}</span>
                        ${stat.is_correct ? '<span class="correct-indicator">âœ“ POPRAWNA</span>' : ''}
                    </div>
                    <span class="stat-count">${stat.count} osÃ³b (${stat.percentage}%)</span>
                </div>
                <div class="stat-bar-container">
                    <div class="stat-bar ${barClass}" style="width: 0%">
                        ${stat.percentage}%
                    </div>
                </div>
            `;

            statisticsContainer.appendChild(statItem);

            // Animacja paska po dodaniu do DOM
            setTimeout(() => {
                const bar = statItem.querySelector('.stat-bar');
                bar.style.width = `${Math.max(stat.percentage, 5)}%`;
            }, 100 + index * 100);
        });

        // Ukryj QR section, pokaÅ¼ statystyki
        qrSection.style.display = 'none';
        statisticsSection.style.display = 'block';
    }

    // SprawdÅº przy zaÅ‚adowaniu typ kodu QR na podstawie przekazanego kodu
    // JeÅ›li kod jest zapasowy (rÃ³Å¼ny od podstawowego), pokaÅ¼ odpowiedniÄ… etykietÄ™
    const currentQrCode = qrCodeDisplay.textContent;
    // DomyÅ›lnie zakÅ‚adamy, Å¼e to backup kod jeÅ›li zostaÅ‚ wygenerowany
    // (Flask route przekazuje backup_qr_code jeÅ›li istnieje)
    qrBadge.textContent = 'ðŸ“± KOD DOSTÄ˜PU';
    qrBadge.style.background = '#667eea';
});
</script>
{% endblock %}
