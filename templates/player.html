{% extends 'base.html' %}

{% block title %}Gracz - Saper{% endblock %}

{% block content %}
<div class="container mt-4">
    <div id="name-input-section" class="text-center">
        <h2>Witaj w grze Saper!</h2>
        <div class="mb-3">
            <label for="player-name" class="form-label">Podaj swoje imię:</label>
            <input type="text" class="form-control" id="player-name" required>
        </div>
        <button class="btn btn-primary">Dołącz do Gry i Skanuj Kod</button>
    </div>

    <div id="quiz-section" class="text-center" style="display: none;">
        <h3>Pytanie:</h3>
        <p id="question" class="lead"></p>
        <div id="answers" class="d-grid gap-2 mt-3">
            <!-- Odpowiedzi będą wstawiane tutaj dynamicznie -->
        </div>
    </div>

    <div id="message-section" class="alert alert-info mt-3" style="display: none;">
        <!-- Powiadomienia dla gracza -->
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const nameInputSection = document.getElementById('name-input-section');
    const quizSection = document.getElementById('quiz-section');
    const messageSection = document.getElementById('message-section');
    const playerNameInput = document.getElementById('player-name');
    const startButton = nameInputSection.querySelector('button');
    const questionEl = document.getElementById('question');
    const answersEl = document.getElementById('answers');

    const QR_CODE = "{{ qr_code }}";
    const EVENT_ID = parseInt("{{ event_id }}", 10);
    let currentQuestionId = null;
    
    // Używamy sessionStorage, aby dane gracza były unikalne dla karty przeglądarki
    let playerId = sessionStorage.getItem(`saperPlayerId_${EVENT_ID}`);
    let playerName = sessionStorage.getItem(`saperPlayerName_${EVENT_ID}`);

    function showMessage(text, type = 'info', duration = 0) {
        messageSection.textContent = text;
        messageSection.className = `alert alert-${type} mt-3`;
        messageSection.style.display = 'block';
        quizSection.style.display = 'none';
        nameInputSection.style.display = 'none';

        if (duration > 0) {
            setTimeout(() => {
                messageSection.style.display = 'none';
            }, duration * 1000);
        }
    }

    function handleScanResponse(data) {
        if (data.status === 'question') {
            nameInputSection.style.display = 'none';
            messageSection.style.display = 'none';
            quizSection.style.display = 'block';
            displayQuestion(data.question);
        } else {
            const messageType = data.status === 'wait' ? 'warning' : 'info';
            showMessage(data.message, messageType);
        }
    }

    function displayQuestion(question) {
        currentQuestionId = question.id;
        questionEl.textContent = question.text;
        answersEl.innerHTML = '';
        const options = ['a', 'b', 'c'];
        options.forEach(opt => {
            if (question[`option_${opt}`]) {
                const btn = document.createElement('button');
                btn.className = 'btn btn-outline-secondary';
                btn.textContent = question[`option_${opt}`];
                btn.dataset.answer = opt;
                answersEl.appendChild(btn);
            }
        });
    }

    async function scanQrCode() {
        try {
            const response = await fetch('/api/scan_qr', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ player_id: playerId, qr_code: QR_CODE, event_id: EVENT_ID })
            });

            if (response.status === 401) { // Nieautoryzowany / Błędne ID gracza
                sessionStorage.removeItem(`saperPlayerId_${EVENT_ID}`);
                sessionStorage.removeItem(`saperPlayerName_${EVENT_ID}`);
                showMessage('Twoja sesja wygasła. Zarejestruj się ponownie.', 'warning');
                setTimeout(() => { nameInputSection.style.display = 'block'; messageSection.style.display = 'none'; }, 2500);
                return;
            }

            const data = await response.json();
             if (!response.ok) {
                throw new Error(data.message || 'Wystąpił nieznany błąd podczas skanowania.');
            }
            handleScanResponse(data);
        } catch(error) {
             showMessage(`Błąd: ${error.message}`, 'danger');
        }
    }

    async function registerAndScan() {
        const name = playerNameInput.value.trim();
        if (!name) {
            alert('Proszę podać imię.');
            return;
        }

        try {
            const response = await fetch('/api/register_player', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name: name, event_id: EVENT_ID })
            });
            
            const data = await response.json();
            if (!response.ok) throw new Error(data.error || 'Nie udało się zarejestrować.');
            
            playerId = data.id;
            playerName = data.name;
            sessionStorage.setItem(`saperPlayerId_${EVENT_ID}`, playerId);
            sessionStorage.setItem(`saperPlayerName_${EVENT_ID}`, playerName);
            
            await scanQrCode(); // Po udanej rejestracji od razu skanujemy kod
            
        } catch(error) {
            alert(`Błąd: ${error.message}`);
        }
    }

    answersEl.addEventListener('click', async (event) => {
        if (event.target.tagName === 'BUTTON') {
            const answer = event.target.dataset.answer;
            try {
                const response = await fetch('/api/answer', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ player_id: playerId, question_id: currentQuestionId, answer: answer, event_id: EVENT_ID })
                });
                const data = await response.json();
                if (!response.ok) throw new Error(data.error || 'Błąd odpowiedzi');

                if (data.correct) {
                    showMessage(`Dobrze! Zdobywasz 10 punktów i literę: ${data.letter}`, 'success');
                } else {
                    showMessage('Zła odpowiedź. Tracisz 5 punktów.', 'danger');
                }
            } catch(error) {
                showMessage(`Błąd: ${error.message}`, 'danger');
            }
        }
    });
    
    startButton.addEventListener('click', registerAndScan);

    // --- Inicjalizacja ---
    if (playerId && playerName) {
        nameInputSection.style.display = 'none';
        scanQrCode(); // Jeśli gracz jest już znany, od razu skanuj kod
    } else {
        nameInputSection.style.display = 'block';
    }
});
</script>
{% endblock %}

