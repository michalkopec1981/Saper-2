{% extends 'base.html' %}

{% block title %}Zarządzaj Kodami QR - Saper{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="card mx-auto" style="max-width: 600px;">
        <div class="card-header">
            <h1 class="card-title text-center mb-0">Zarządzaj Kodami QR</h1>
            <h2 class="text-center text-muted h4">{{ event_name }} (Event {{ event_id }})</h2>
        </div>
        <div class="card-body">
            <p class="text-center">Ustaw liczbę kodów QR, które będą dostępne w grze. Pamiętaj, aby zrobić to przed rozpoczęciem eventu.</p>
            
            <div class="mb-3">
                <label for="white-codes-count" class="form-label">Liczba białych kodów QR:</label>
                <input type="number" class="form-control" id="white-codes-count" value="{{ white_codes_count or 5 }}" min="1" max="100">
            </div>
            <div class="mb-3">
                <label for="red-codes-count" class="form-label">Liczba "czerwonych" kodów QR:</label>
                <input type="number" class="form-control" id="red-codes-count" value="{{ red_codes_count or 5 }}" min="0" max="100">
            </div>
            
            <div class="d-grid gap-2 mt-4">
                <button id="generate-qrcodes" class="btn btn-primary">Generuj / Zaktualizuj Kody QR</button>
                <a href="{{ url_for('list_qrcodes_public', event_id=event_id) }}" target="_blank" class="btn btn-info">Podgląd kodów QR</a>
            </div>
            <div id="status-message" class="mt-3 text-center" style="display: none;"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const generateBtn = document.getElementById('generate-qrcodes');
    const statusEl = document.getElementById('status-message');
    const eventId = {{ event_id }};

    generateBtn.addEventListener('click', async () => {
        const whiteCount = document.getElementById('white-codes-count').value;
        const redCount = document.getElementById('red-codes-count').value;

        statusEl.textContent = 'Generowanie...';
        statusEl.className = 'alert alert-info';
        statusEl.style.display = 'block';

        try {
            const response = await fetch('/api/superhost/qrcodes/generate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    event_id: eventId,
                    white_codes_count: whiteCount,
                    red_codes_count: redCount
                })
            });

            const result = await response.json();

            if (!response.ok) {
                throw new Error(result.message || 'Błąd serwera.');
            }
            
            statusEl.textContent = result.message;
            statusEl.className = 'alert alert-success';

        } catch (error) {
            console.error('Błąd generowania kodów:', error);
            statusEl.textContent = `Błąd: ${error.message}`;
            statusEl.className = 'alert alert-danger';
        }
    });
});
</script>
{% endblock %}
