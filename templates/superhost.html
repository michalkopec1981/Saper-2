
{% extends 'base.html' %}

{% block title %}Panel Superhosta - Saper{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="card mx-auto" style="max-width: 800px;">
        <div class="card-header">
            <h1 class="card-title text-center mb-0">Panel Zarządzania Grą</h1>
        </div>
        <div class="card-body">
            <p class="text-center text-muted">Zarządzaj poszczególnymi eventami, ustawiaj dane logowania i resetuj stan gry.</p>
            
            <div id="events-container">
                <!-- Event control panels will be dynamically inserted here -->
            </div>
            <div id="status-container" class="mt-3 text-center"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const eventsContainer = document.getElementById('events-container');
    const statusContainer = document.getElementById('status-container');
    const MAX_EVENTS = 5;

    function createEventPanel(hostData) {
        const panel = document.createElement('div');
        panel.className = 'card mb-3';
        panel.dataset.eventId = hostData.id;

        panel.innerHTML = `
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                     <h5 class="card-title mb-0">EVENT ${String(hostData.id).padStart(2, '0')} - <span class="event-name-display">${hostData.event_name || 'Brak nazwy'}</span></h5>
                     <button class="btn btn-danger btn-sm reset-btn">RESET GRY</button>
                </div>
                <hr>
                <div class="row g-3 align-items-end">
                    <div class="col-md-4">
                        <label for="login-${hostData.id}" class="form-label">LOGIN</label>
                        <input type="text" id="login-${hostData.id}" class="form-control" value="${hostData.login}" required>
                    </div>
                    <div class="col-md-4">
                        <label for="password-${hostData.id}" class="form-label">HASŁO</label>
                        <input type="text" id="password-${hostData.id}" class="form-control" placeholder="Nowe lub puste">
                    </div>
                    <div class="col-md-4">
                         <label for="event-name-${hostData.id}" class="form-label">Nazwa Eventu</label>
                         <input type="text" id="event-name-${hostData.id}" class="form-control" value="${hostData.event_name || ''}">
                    </div>
                </div>
                 <div class="d-grid gap-2 mt-3">
                    <button class="btn btn-success ok-btn">OK (Zapisz Login/Hasło/Nazwę)</button>
                </div>
            </div>
        `;
        return panel;
    }

    async function loadHosts() {
        try {
            const response = await fetch('/api/hosts');
            if (!response.ok) throw new Error('Nie udało się pobrać danych hostów.');
            
            const hosts = await response.json();
            eventsContainer.innerHTML = '';
            
            const hostMap = new Map(hosts.map(h => [h.id, h]));

            for (let i = 1; i <= MAX_EVENTS; i++) {
                const hostData = hostMap.get(i) || { id: i, login: `host${i}`, event_name: `Event #${i}` };
                eventsContainer.appendChild(createEventPanel(hostData));
            }

        } catch (error) {
            showStatus(error.message, 'danger');
        }
    }

    function showStatus(message, type = 'info', duration = 3000) {
        statusContainer.innerHTML = `<div class="alert alert-${type}" role="alert">${message}</div>`;
        setTimeout(() => {
            if (statusContainer.firstChild) {
                statusContainer.firstChild.remove();
            }
        }, duration);
    }

    eventsContainer.addEventListener('click', async (e) => {
        const panel = e.target.closest('.card');
        if (!panel) return;

        const eventId = panel.dataset.eventId;

        // Handle RESET button
        if (e.target.classList.contains('reset-btn')) {
            if (!confirm(`Czy na pewno chcesz zresetować całą grę dla EVENTU ${eventId}? Usunie to wszystkich graczy, kody i postęp.`)) {
                return;
            }
            try {
                const response = await fetch(`/api/event/${eventId}/reset`, { method: 'POST' });
                const result = await response.json();
                if (!response.ok) throw new Error(result.message || 'Błąd serwera');
                showStatus(result.message, 'success');
            } catch (error) {
                showStatus(`Błąd resetowania: ${error.message}`, 'danger');
            }
        }

        // Handle OK button
        if (e.target.classList.contains('ok-btn')) {
            const login = panel.querySelector(`#login-${eventId}`).value.trim();
            const password = panel.querySelector(`#password-${eventId}`).value;
            const event_name = panel.querySelector(`#event-name-${eventId}`).value.trim();

            if (!login) {
                alert('Login nie może być pusty.');
                return;
            }
            
            const payload = { id: eventId, login, password, event_name };

            try {
                const response = await fetch('/api/hosts/update', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify([payload]) // API expects a list
                });

                const result = await response.json();
                if (!response.ok) throw new Error(result.message || 'Błąd serwera');
                
                showStatus(result.message, 'success');
                // Password field is no longer cleared after saving
                panel.querySelector('.event-name-display').textContent = event_name; // Update displayed name
            } catch (error) {
                showStatus(`Błąd zapisu: ${error.message}`, 'danger');
            }
        }
    });

    loadHosts();
});
</script>
{% endblock %}
