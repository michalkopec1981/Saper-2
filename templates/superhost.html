{% extends 'base.html' %}

{% block title %}Panel Superhosta - Saper{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="card mx-auto" style="max-width: 800px;">
        <div class="card-header">
            <h1 class="card-title text-center mb-0">Panel Superhosta</h1>
        </div>
        <div class="card-body">
            <p class="text-center text-muted">Zarządzaj eventami, resetuj grę i konfiguruj kody QR.</p>
            <div id="hosts-container" class="list-group">
                <!-- Host controls will be dynamically inserted here -->
            </div>
            <div id="status-message" class="mt-3 text-center" style="display: none;"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const hostsContainer = document.getElementById('hosts-container');
    const statusEl = document.getElementById('status-message');

    async function loadHosts() {
        try {
            const response = await fetch('/api/hosts');
            if (!response.ok) throw new Error('Nie udało się pobrać danych hostów.');
            
            const hosts = await response.json();
            hostsContainer.innerHTML = '';

            hosts.forEach(host => {
                const div = document.createElement('div');
                div.className = 'list-group-item d-flex justify-content-between align-items-center';
                div.innerHTML = `
                    <div>
                        <h5 class="mb-1">${host.event_name}</h5>
                        <small class="text-muted">Login: ${host.login}</small>
                    </div>
                    <div>
                        <a href="/superhost/qrcodes/${host.id}" class="btn btn-primary me-2">KODY QR</a>
                        <button class="btn btn-danger btn-reset" data-event-id="${host.id}">RESET GRY</button>
                    </div>
                `;
                hostsContainer.appendChild(div);
            });

        } catch (error) {
            console.error('Błąd:', error);
            hostsContainer.innerHTML = `<div class="alert alert-danger">${error.message}</div>`;
        }
    }

    hostsContainer.addEventListener('click', async (event) => {
        if (event.target.classList.contains('btn-reset')) {
            const eventId = event.target.dataset.eventId;
            if (confirm(`Czy na pewno chcesz zresetować WSZYSTKIE dane dla eventu ${eventId}? Tej operacji nie można cofnąć.`)) {
                
                statusEl.textContent = 'Resetowanie...';
                statusEl.className = 'alert alert-info';
                statusEl.style.display = 'block';

                try {
                    const response = await fetch(`/api/event/${eventId}/reset`, { method: 'POST' });
                    const result = await response.json();

                    if (!response.ok) throw new Error(result.message || 'Błąd serwera.');

                    statusEl.textContent = result.message;
                    statusEl.className = 'alert alert-success';

                } catch (error) {
                    statusEl.textContent = `Błąd: ${error.message}`;
                    statusEl.className = 'alert alert-danger';
                }
            }
        }
    });

    loadHosts();
});
</script>
{% endblock %}

