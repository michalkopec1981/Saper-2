{% extends 'base.html' %}
{% block title %}AR Scanner - {{ event.name }}{% endblock %}

{% block styles %}
{{ super() }}
<style>
    #camera-feed {
        width: 100%;
        max-height: 400px;
        border-radius: 8px;
        background: #000;
    }

    #ar-status {
        font-size: 1.5em;
        font-weight: bold;
        margin: 20px 0;
    }

    .scanning-indicator {
        width: 100%;
        height: 100%;
        position: absolute;
        top: 0;
        left: 0;
        border: 3px solid transparent;
        border-radius: 8px;
        animation: scan-pulse 1.5s ease-in-out infinite;
    }

    @keyframes scan-pulse {
        0%, 100% {
            border-color: rgba(0, 123, 255, 0);
        }
        50% {
            border-color: rgba(0, 123, 255, 0.8);
        }
    }

    .object-found {
        border: 5px solid #28a745 !important;
        animation: none !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4" style="max-width: 600px;">
    <div class="text-center">
        <h1>üîç AR Scanner</h1>
        <h3 class="text-muted">{{ event.name }}</h3>
        <hr>
    </div>

    <!-- Sekcja podania imienia -->
    <div id="name-input-section" class="text-center">
        <p class="lead">Zanim rozpoczniesz skanowanie, podaj swoje imiƒô:</p>
        <div class="mb-3">
            <input type="text" class="form-control" id="player-name" placeholder="Twoje imiƒô lub nazwa dru≈ºyny" required>
        </div>
        <button id="start-scanner-btn" class="btn btn-primary btn-lg">
            Rozpocznij skanowanie AR
        </button>
    </div>

    <!-- Sekcja skanera AR -->
    <div id="scanner-section" style="display: none;">
        <div id="ar-status" class="text-center text-primary">
            Szukam obiekt√≥w...
        </div>

        <div style="position: relative;">
            <video id="camera-feed" autoplay playsinline></video>
            <div id="scanning-indicator" class="scanning-indicator"></div>
        </div>

        <canvas id="capture-canvas" style="display: none;"></canvas>

        <div class="mt-3 text-center">
            <p class="text-muted">Skieruj kamerƒô na obiekt skonfigurowany przez organizatora</p>
            <button id="stop-scanner-btn" class="btn btn-secondary">
                Zatrzymaj skaner
            </button>
        </div>

        <div id="player-info" class="mt-3 text-center">
            <p class="mb-0"><strong>Gracz:</strong> <span id="player-name-display"></span></p>
            <p class="mb-0"><strong>Punkty:</strong> <span id="player-score">0</span></p>
        </div>
    </div>

    <!-- Sekcja pytania quiz (je≈õli rozpoznany obiekt to quiz) -->
    <div id="quiz-section" style="display: none;" class="text-center">
        <h3>Pytanie:</h3>
        <p id="question-text" class="lead"></p>
        <div id="answers" class="d-grid gap-2 mt-3"></div>
    </div>

    <!-- Sekcja gry Snake -->
    <div id="snake-game-section" style="display: none;">
        <div class="text-center">
            <h3>üêç Snake</h3>
            <p>ZdobƒÖd≈∫ 20 punkt√≥w!</p>
            <canvas id="snake-canvas" width="300" height="300" style="border: 2px solid #333; background: #000;"></canvas>
            <div class="mt-3">
                <button class="btn btn-primary btn-lg" onclick="moveSnake('up')">‚ñ≤</button><br>
                <button class="btn btn-primary btn-lg me-2" onclick="moveSnake('left')">‚óÑ</button>
                <button class="btn btn-primary btn-lg" onclick="moveSnake('right')">‚ñ∫</button><br>
                <button class="btn btn-primary btn-lg mt-2" onclick="moveSnake('down')">‚ñº</button>
            </div>
            <p class="mt-3"><strong>Wynik:</strong> <span id="snake-score">0</span> / 20</p>
        </div>
    </div>

    <!-- Komunikaty -->
    <div id="message-section" style="display: none;" class="alert mt-3"></div>
</div>

<script>
const EVENT_ID = {{ event.id }};
let playerId = null;
let playerName = null;
let scanning = false;
let scanInterval = null;
let stream = null;

// Check if player is already logged in
window.addEventListener('DOMContentLoaded', async function() {
    const storedPlayerId = localStorage.getItem(`saperPlayerId_${EVENT_ID}`);
    const storedPlayerName = localStorage.getItem(`saperPlayerName_${EVENT_ID}`);

    if (storedPlayerId && storedPlayerName) {
        // Player already logged in, go directly to scanner
        playerId = storedPlayerId;
        playerName = storedPlayerName;
        document.getElementById('player-name-display').textContent = playerName;

        // Ukryj sekcjƒô imienia, poka≈º skaner
        document.getElementById('name-input-section').style.display = 'none';
        document.getElementById('scanner-section').style.display = 'block';

        // Uruchom kamerƒô
        await startCamera();
        startScanning();
    } else {
        // Show registration form
        document.getElementById('name-input-section').style.display = 'block';
    }
});

// Rozpocznij skaner
document.getElementById('start-scanner-btn').addEventListener('click', async () => {
    const nameInput = document.getElementById('player-name');
    playerName = nameInput.value.trim();

    if (!playerName) {
        alert('Podaj swoje imiƒô!');
        return;
    }

    // Register player
    try {
        const response = await fetch('/api/player/register', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                name: playerName,
                event_id: EVENT_ID
            })
        });

        const data = await response.json();

        if (!response.ok) {
            throw new Error(data.error || 'B≈ÇƒÖd rejestracji');
        }

        // Save player info
        playerId = data.id;
        localStorage.setItem(`saperPlayerId_${EVENT_ID}`, playerId);
        localStorage.setItem(`saperPlayerName_${EVENT_ID}`, playerName);

        document.getElementById('player-name-display').textContent = playerName;

        // Ukryj sekcjƒô imienia, poka≈º skaner
        document.getElementById('name-input-section').style.display = 'none';
        document.getElementById('scanner-section').style.display = 'block';

        // Uruchom kamerƒô
        await startCamera();
        startScanning();

    } catch (error) {
        alert('B≈ÇƒÖd: ' + error.message);
    }
});

async function startCamera() {
    try {
        stream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: 'environment' }
        });

        const video = document.getElementById('camera-feed');
        video.srcObject = stream;
        video.play();
    } catch (error) {
        alert('Nie mo≈ºna uruchomiƒá kamery: ' + error.message);
        throw error;
    }
}

function startScanning() {
    scanning = true;
    document.getElementById('ar-status').textContent = 'Szukam obiekt√≥w...';
    document.getElementById('ar-status').className = 'text-center text-primary';

    // Skanuj co 1 sekundƒô
    scanInterval = setInterval(async () => {
        if (!scanning) return;

        try {
            await scanForObjects();
        } catch (error) {
            console.error('B≈ÇƒÖd skanowania:', error);
        }
    }, 1000);
}

async function scanForObjects() {
    const video = document.getElementById('camera-feed');
    const canvas = document.getElementById('capture-canvas');
    const ctx = canvas.getContext('2d');

    // Dostosuj rozmiar canvas do video
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;

    // Zr√≥b snapshot
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

    // Konwertuj do base64
    const imageData = canvas.toDataURL('image/jpeg', 0.7);

    // Wy≈õlij do API
    const response = await fetch('/api/player/ar/recognize', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            image_data: imageData,
            event_id: EVENT_ID,
            player_id: playerId
        })
    });

    const result = await response.json();

    if (result.recognized) {
        // Obiekt rozpoznany!
        objectRecognized(result);
    }
}

function objectRecognized(result) {
    // Zatrzymaj skanowanie
    scanning = false;
    clearInterval(scanInterval);

    // Zatrzymaj kamerƒô
    if (stream) {
        stream.getTracks().forEach(track => track.stop());
    }

    // Poka≈º komunikat
    document.getElementById('ar-status').textContent = `‚úÖ Rozpoznano: ${result.object_name}!`;
    document.getElementById('ar-status').className = 'text-center text-success';
    document.getElementById('scanning-indicator').className = 'scanning-indicator object-found';

    // Ukryj skaner
    setTimeout(() => {
        document.getElementById('scanner-section').style.display = 'none';

        // Uruchom odpowiedniƒÖ funkcjƒô z zak≈Çadki
        const gameType = result.game_type;

        // Pytania - r√≥≈ºne poziomy trudno≈õci
        if (gameType.startsWith('questions_') || gameType.startsWith('ai_')) {
            const difficulty = gameType.includes('easy') ? '≈Çatwe' :
                             gameType.includes('medium') ? '≈õrednie' :
                             gameType.includes('hard') ? 'trudne' :
                             gameType.includes('mixed') ? 'mieszane' : '';
            const round = gameType.includes('round2') ? ' (Runda 2)' :
                         gameType.includes('round3') ? ' (Runda 3)' : '';
            const type = gameType.startsWith('ai_') ? 'AI' : '';

            showMessage(`üéØ Uruchamiam: ${type} Pytania ${difficulty}${round}`, 'success');
            // Tutaj bƒôdzie logika uruchomienia pyta≈Ñ z odpowiednim filtrem

        // Wr√≥≈ºka AI
        } else if (gameType === 'fortune') {
            showMessage('üîÆ Uruchamiam: Wr√≥≈ºka AI', 'success');
            // Przekierowanie do wr√≥≈ºki AI
            setTimeout(() => {
                window.location.href = '/fortune/' + eventId;
            }, 2000);

        // Minigry
        } else if (gameType === 'minigames') {
            showMessage('üéÆ Uruchamiam: Minigry', 'success');
            // Tutaj bƒôdzie logika uruchomienia minigier

        // Foto
        } else if (gameType === 'photo') {
            showMessage('üì∏ Uruchamiam: Wyzwanie Foto', 'success');
            // Tutaj bƒôdzie logika uruchomienia wyzwania foto

        // G≈Çosowanie
        } else if (gameType === 'voting') {
            showMessage('üó≥Ô∏è Uruchamiam: G≈Çosowanie', 'success');
            // Tutaj bƒôdzie logika uruchomienia g≈Çosowania

        // Na ≈ºywo
        } else if (gameType === 'live') {
            showMessage('üì° Uruchamiam: Tryb Na ≈ªywo', 'success');
            // Tutaj bƒôdzie logika uruchomienia trybu na ≈ºywo

        // Stare warto≈õci (zachowane dla kompatybilno≈õci)
        } else if (gameType === 'quiz') {
            showQuiz(result.question);
        } else if (gameType === 'snake') {
            showSnakeGame();
        } else if (gameType === 'tetris') {
            showMessage('Tetris nie jest jeszcze zaimplementowany', 'warning');
        } else if (gameType === 'arkanoid') {
            showMessage('Arkanoid nie jest jeszcze zaimplementowany', 'warning');
        } else {
            showMessage('‚ö†Ô∏è Nieznany typ gry: ' + gameType, 'warning');
        }
    }, 2000);
}

function showQuiz(question) {
    if (!question) {
        showMessage('Brak dostƒôpnych pyta≈Ñ!', 'warning');
        return;
    }

    document.getElementById('quiz-section').style.display = 'block';
    document.getElementById('question-text').textContent = question.text;

    const answersDiv = document.getElementById('answers');
    answersDiv.innerHTML = '';

    const options = [
        { key: 'a', text: question.option_a },
        { key: 'b', text: question.option_b },
        { key: 'c', text: question.option_c }
    ];

    options.forEach(option => {
        const btn = document.createElement('button');
        btn.className = 'btn btn-outline-primary btn-lg';
        btn.textContent = `${option.key.toUpperCase()}: ${option.text}`;
        btn.onclick = () => submitAnswer(question.id, option.key);
        answersDiv.appendChild(btn);
    });
}

async function submitAnswer(questionId, answer) {
    // Tutaj dodaj logikƒô sprawdzania odpowiedzi
    // Dla uproszczenia, po prostu pokazujemy komunikat
    showMessage('Odpowied≈∫ przes≈Çana! Wr√≥ƒá do skanera, aby kontynuowaƒá.', 'success');

    setTimeout(() => {
        resetScanner();
    }, 3000);
}

function showSnakeGame() {
    document.getElementById('snake-game-section').style.display = 'block';
    // Tutaj dodaj logikƒô gry Snake
    showMessage('Gra Snake - steruj strza≈Çkami!', 'info');
}

function showMessage(text, type = 'info') {
    const messageDiv = document.getElementById('message-section');
    messageDiv.textContent = text;
    messageDiv.className = `alert alert-${type} mt-3`;
    messageDiv.style.display = 'block';

    setTimeout(() => {
        messageDiv.style.display = 'none';
    }, 5000);
}

function resetScanner() {
    document.getElementById('quiz-section').style.display = 'none';
    document.getElementById('snake-game-section').style.display = 'none';
    document.getElementById('scanner-section').style.display = 'block';

    startCamera().then(() => {
        startScanning();
    });
}

document.getElementById('stop-scanner-btn').addEventListener('click', () => {
    scanning = false;
    clearInterval(scanInterval);

    if (stream) {
        stream.getTracks().forEach(track => track.stop());
    }

    document.getElementById('scanner-section').style.display = 'none';
    document.getElementById('name-input-section').style.display = 'block';
});
</script>
{% endblock %}
