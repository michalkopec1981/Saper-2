{% extends 'base.html' %}
{% block title %}Ekran Gry - {{ event.name }}{% endblock %}
{% block styles %}
{{ super() }}
<style>
    body { background-color: #212529; color: white; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    .container-fluid { max-width: 100vw; overflow-x: hidden; }
    .main-panel { height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center; }
    .side-panel { height: 100vh; background-color: rgba(0,0,0,0.2); padding: 2rem; display: flex; flex-direction: column; }
    #anagram { font-size: 5rem; font-weight: bold; letter-spacing: 0.5rem; }
    #bomb-video-container { width: 100%; max-width: 600px; }
    #bomb-fuse { width: 100%; border-radius: 15px; }
    .list-group-item { background-color: rgba(255,255,255,0.1); border-color: rgba(255,255,255,0.2); color: white; }
    .carousel-item img { max-height: 250px; width: 100%; object-fit: contain; }
    .carousel-caption { background-color: rgba(0, 0, 0, 0.7); padding: 10px; border-radius: 5px; }
    .carousel-caption h5 { font-size: 1.2rem; margin: 0; }
    /* Komunikaty hosta */
    #host-message-overlay {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 9999;
        max-width: 90%;
        width: 800px;
    }
    
    #host-message-container {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px 30px;
        border-radius: 15px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        font-size: 1.5rem;
        text-align: center;
        font-weight: bold;
        animation: slideDown 0.5s ease-out, pulse 2s infinite;
        border: 3px solid rgba(255,255,255,0.3);
    }
    
    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-50px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    @keyframes pulse {
        0%, 100% {
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }
        50% {
            box-shadow: 0 10px 60px rgba(102, 126, 234, 0.8);
        }
    }
    
    .message-icon {
        font-size: 2rem;
        margin-right: 15px;
        animation: bounce 1s infinite;
    }
    
    @keyframes bounce {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-10px); }
    }

    /* Bomba z lontem */
    #bomb-container {
        width: 100%;
        max-height: 20vh;
        position: relative;
        margin-top: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    #bomb-svg {
        width: 100%;
        height: auto;
        max-height: 20vh;
    }

    @keyframes spark {
        0%, 100% { opacity: 1; transform: scale(1); }
        50% { opacity: 0.6; transform: scale(1.3); }
    }
</style>
{% endblock %}
{% block content %}
<div class="container-fluid">
    <div class="row g-0">
        <div class="col-md-8 main-panel">
            <h1 id="anagram" class="font-monospace text-center">_ _ _ _ _ _ _ _ _ _</h1>
            <p class="lead">Minimalna liczba liter do rozbrojenia bomby: <span id="min-letters">10</span></p>
            <div id="bomb-video-container">
                <video id="bomb-fuse" muted autoplay loop playsinline>
                    <source src="{{ url_for('static', filename='bomb_fuse.mp4') }}" type="video/mp4">
                    Twoja przeglÄ…darka nie obsÅ‚uguje wideo.
                </video>
            </div>
        </div>
        <div class="col-md-4 side-panel">
            <h2 class="text-center">Ranking</h2>
            <ul id="leaderboard" class="list-group mb-4 flex-grow-1" style="overflow-y: auto;"></ul>
            <h2 class="text-center mt-auto">Czas: <span id="timer" class="display-4">00:00</span></h2>

            <!-- ðŸ’£ BOMBA Z LONTEM -->
            <div id="bomb-container">
                <svg id="bomb-svg" viewBox="0 0 400 120" xmlns="http://www.w3.org/2000/svg">
                    <!-- Definicje gradientÃ³w i filtrÃ³w -->
                    <defs>
                        <linearGradient id="fuseGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                            <stop offset="0%" style="stop-color:#8B4513;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#654321;stop-opacity:1" />
                        </linearGradient>
                        <filter id="glow">
                            <feGaussianBlur stdDeviation="2" result="coloredBlur"/>
                            <feMerge>
                                <feMergeNode in="coloredBlur"/>
                                <feMergeNode in="SourceGraphic"/>
                            </feMerge>
                        </filter>
                    </defs>

                    <!-- Lont (zakrzywiony - od lewej do bomby) -->
                    <path id="fuse-path" d="M 10 60 Q 150 20, 300 60" stroke="url(#fuseGradient)" stroke-width="4" fill="none"/>

                    <!-- WypalajÄ…cy siÄ™ fragment lonta (na wierzchu) -->
                    <path id="fuse-burning" d="M 10 60 Q 150 20, 300 60"
                          stroke="#ff6600"
                          stroke-width="4"
                          fill="none"
                          stroke-dasharray="280"
                          stroke-dashoffset="0"
                          style="transition: stroke-dashoffset 1s linear"/>

                    <!-- Iskra na koÅ„cu wypalajÄ…cego siÄ™ lonta -->
                    <circle id="fuse-spark" cx="10" cy="60" r="5" fill="#FFD700" filter="url(#glow)"
                            style="animation: spark 0.5s infinite"/>
                    <circle id="fuse-spark2" cx="10" cy="60" r="3" fill="#FFA500"
                            style="animation: spark 0.5s infinite 0.25s"/>

                    <!-- Bomba (po prawej stronie) -->
                    <circle cx="360" cy="60" r="35" fill="#2a2a2a" stroke="#000" stroke-width="2"/>
                    <circle cx="355" cy="55" r="5" fill="#444"/> <!-- Highlight -->
                    <circle cx="365" cy="70" r="3" fill="#555"/> <!-- Åšruba -->

                    <!-- Bezpiecznik na gÃ³rze bomby -->
                    <rect x="358" y="25" width="4" height="10" fill="#666"/>
                    <rect x="357" y="23" width="6" height="4" fill="#888" rx="1"/>
                </svg>
            </div>

            <!-- ðŸ“¸ KARUZELA ZDJÄ˜Ä† -->
            <div id="funny-photos-carousel" class="carousel slide mt-4" data-bs-ride="carousel" data-bs-interval="5000">
                <div class="carousel-inner" id="photos-carousel-inner">
                    <div class="carousel-item active">
                        <div class="text-center p-5">
                            <p>ðŸ“¸ Czekamy na Å›mieszne zdjÄ™cia!</p>
                        </div>
                    </div>
                </div>
                <button class="carousel-control-prev" type="button" data-bs-target="#funny-photos-carousel" data-bs-slide="prev">
                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Poprzednie</span>
                </button>
                <button class="carousel-control-next" type="button" data-bs-target="#funny-photos-carousel" data-bs-slide="next">
                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">NastÄ™pne</span>
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block scripts %}
{{ super() }}
<script src="https://cdn.socket.io/4.5.2/socket.io.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    const EVENT_ID = {{ event.id }};
    const socket = io();
    const leaderboardEl = document.getElementById('leaderboard');
    const passwordEl = document.getElementById('anagram');
    const timerEl = document.getElementById('timer');
    const photoCarouselInner = document.getElementById('photos-carousel-inner');

    // ðŸ’£ Elementy bomby
    const fuseBurning = document.getElementById('fuse-burning');
    const fuseSpark = document.getElementById('fuse-spark');
    const fuseSpark2 = document.getElementById('fuse-spark2');
    const fusePath = document.getElementById('fuse-path');
    const fuseLength = 280; // CaÅ‚kowita dÅ‚ugoÅ›Ä‡ lonta w SVG
    let totalGameTime = null; // CaÅ‚kowity czas gry w sekundach

    // ðŸ“¸ Funkcja Å‚adowania zdjÄ™Ä‡ z serwera
    async function loadPhotos() {
        try {
            const response = await fetch(`/api/photos/${EVENT_ID}`);
            if (!response.ok) return;
            
            const photos = await response.json();
            
            if (photos.length === 0) {
                photoCarouselInner.innerHTML = `
                    <div class="carousel-item active">
                        <div class="text-center p-5">
                            <p>ðŸ“¸ Czekamy na Å›mieszne zdjÄ™cia!</p>
                        </div>
                    </div>
                `;
                return;
            }
            
            // WyczyÅ›Ä‡ karuzele i dodaj zdjÄ™cia
            photoCarouselInner.innerHTML = '';
            photos.forEach((photo, index) => {
                const isActive = index === 0 ? 'active' : '';
                const newItem = document.createElement('div');
                newItem.className = `carousel-item ${isActive}`;
                newItem.innerHTML = `
                    <img src="${photo.image_url}" class="d-block w-100" alt="ZdjÄ™cie gracza ${photo.player_name}">
                    <div class="carousel-caption">
                        <h5>ðŸ‘¤ ${photo.player_name}</h5>
                    </div>
                `;
                photoCarouselInner.appendChild(newItem);
            });
        } catch (error) {
            console.error('BÅ‚Ä…d Å‚adowania zdjÄ™Ä‡:', error);
        }
    }

    socket.on('connect', () => {
        console.log('âœ… Socket connected');
        socket.emit('join', { event_id: EVENT_ID });
        loadPhotos(); // ZaÅ‚aduj istniejÄ…ce zdjÄ™cia
    });

    socket.on('leaderboard_update', (players) => {
        leaderboardEl.innerHTML = '';
        if (!players || players.length === 0) {
            leaderboardEl.innerHTML = '<li class="list-group-item">Brak graczy w rankingu.</li>';
            return;
        }
        players.forEach(p => {
            const li = document.createElement('li');
            li.className = 'list-group-item d-flex justify-content-between align-items-center';
            li.innerHTML = `<span>${p.name}</span><span class="badge bg-primary rounded-pill">${p.score} pkt</span>`;
            leaderboardEl.appendChild(li);
        });
    });

    socket.on('password_update', (passwordState) => {
        passwordEl.textContent = passwordState.split('').join(' ');
    });

    socket.on('timer_tick', (data) => {
        const timeLeft = Math.floor(data.time_left);
        const minutes = Math.floor(timeLeft / 60);
        const seconds = timeLeft % 60;
        timerEl.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

        // ðŸ’£ Animacja lonta bomby
        // Oblicz caÅ‚kowity czas gry na podstawie time_left + time_elapsed
        if (totalGameTime === null && data.time_elapsed !== undefined) {
            totalGameTime = Math.floor(data.time_left + data.time_elapsed);
        }

        if (totalGameTime && totalGameTime > 0 && timeLeft >= 0) {
            // Oblicz ile procent czasu pozostaÅ‚o
            const percentageLeft = timeLeft / totalGameTime;

            // Oblicz offset lonta (od 0 do fuseLength)
            // Im mniej czasu, tym wiÄ™kszy offset (lont siÄ™ wypala)
            const offset = fuseLength * (1 - percentageLeft);
            fuseBurning.style.strokeDashoffset = -offset;

            // PrzesuÅ„ iskrÄ™ wzdÅ‚uÅ¼ lonta
            // UÅ¼ywamy path.getPointAtLength() aby uzyskaÄ‡ pozycjÄ™ na krzywej
            const pathLength = fusePath.getTotalLength();
            const pointPosition = pathLength * percentageLeft;
            const point = fusePath.getPointAtLength(pointPosition);

            fuseSpark.setAttribute('cx', point.x);
            fuseSpark.setAttribute('cy', point.y);
            fuseSpark2.setAttribute('cx', point.x);
            fuseSpark2.setAttribute('cy', point.y);

            // Przyspiesz animacjÄ™ iskry gdy pozostaÅ‚o <10% czasu
            if (percentageLeft < 0.1) {
                fuseSpark.style.animation = 'spark 0.1s infinite';
                fuseSpark2.style.animation = 'spark 0.1s infinite 0.05s';
            }
        }
    });
    
    // ðŸ“¸ ObsÅ‚uga nowych zdjÄ™Ä‡ w czasie rzeczywistym
    socket.on('new_photo', (data) => {
        console.log('ðŸ“¸ Nowe zdjÄ™cie otrzymane:', data);
        
        // UsuÅ„ placeholder jeÅ›li istnieje
        const placeholder = photoCarouselInner.querySelector('.text-center');
        if (placeholder) {
            photoCarouselInner.innerHTML = '';
        }
        
        // UsuÅ„ klasÄ™ 'active' ze wszystkich elementÃ³w
        photoCarouselInner.querySelectorAll('.carousel-item').forEach(item => {
            item.classList.remove('active');
        });
        
        // Dodaj nowe zdjÄ™cie na poczÄ…tek (bÄ™dzie aktywne)
        const newItem = document.createElement('div');
        newItem.className = 'carousel-item active';
        newItem.innerHTML = `
            <img src="${data.url}" class="d-block w-100" alt="ZdjÄ™cie gracza ${data.player}">
            <div class="carousel-caption">
                <h5>ðŸ‘¤ ${data.player}</h5>
            </div>
        `;
        
        // Wstaw na poczÄ…tek
        photoCarouselInner.insertBefore(newItem, photoCarouselInner.firstChild);
        
        // JeÅ›li jest wiÄ™cej niÅ¼ 10 zdjÄ™Ä‡, usuÅ„ najstarsze
        const allItems = photoCarouselInner.querySelectorAll('.carousel-item');
        if (allItems.length > 10) {
            allItems[allItems.length - 1].remove();
        }
    });

    // ðŸ“¸ ObsÅ‚uga resetowania zdjÄ™Ä‡ (przy starcie gry)
    socket.on('photos_update', (photos) => {
        console.log('ðŸ“¸ Reset galerii zdjÄ™Ä‡');
        photoCarouselInner.innerHTML = `
            <div class="carousel-item active">
                <div class="text-center p-5">
                    <p>ðŸ“¸ Czekamy na Å›mieszne zdjÄ™cia!</p>
                </div>
            </div>
        `;
    });

    socket.on('game_state_update', (state) => {
        if (state.password) {
            passwordEl.textContent = state.password.split('').join(' ');
        }
    });

// ObsÅ‚uga komunikatÃ³w od hosta
    socket.on('host_message', (data) => {
        console.log('ðŸ“¢ Otrzymano komunikat od hosta:', data.message);
        
        const overlay = document.getElementById('host-message-overlay');
        const messageText = document.getElementById('host-message-text');
        
        if (overlay && messageText) {
            messageText.textContent = data.message;
            overlay.style.display = 'block';
            
            // Ukryj komunikat po 10 sekundach
            setTimeout(() => {
                overlay.style.display = 'none';
            }, 10000);
        }
    });
    
});
</script>
{% endblock %}

