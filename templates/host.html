{% extends 'base.html' %}
{% block title %}Panel Hosta - {{ event.name }}{% endblock %}

{% block styles %}
{{ super() }}
<style>
    .timer-display {
        font-family: monospace;
        font-size: 1.2em;
        color: #333;
    }
</style>
{% endblock %}

{% block content %}
    {% if is_impersonated %}
        <div class="alert alert-info">
            Jesteś zalogowany jako Admin w panelu Hosta.
            <a href="{{ url_for('logout_impersonate') }}" class="btn btn-primary">Powrót do panelu Admina</a>
        </div>
    {% endif %}

    <h1>Panel Hosta: {{ event.name }}</h1>
    <a href="{{ url_for('display', event_id=event.id) }}" class="btn btn-primary mb-3" target="_blank">Otwórz Ekran Gry</a>

    <ul class="nav nav-tabs mb-3">
        <li class="nav-item"><a class="nav-link active" href="#game" data-toggle="tab">Gra</a></li>
        <li class="nav-item"><a class="nav-link" href="#players" data-toggle="tab">Gracze</a></li>
        <li class="nav-item"><a class="nav-link" href="#questions" data-toggle="tab">Pytania</a></li>
        {% if event.is_superhost %}
            <li class="nav-item"><a class="nav-link" href="{{ url_for('list_qrcodes_public', event_id=event.id) }}">Kody QR</a></li>
        {% endif %}
    </ul>

    <div class="tab-content">
        <div class="tab-pane active" id="game">
            <div class="card mb-3">
                <div class="card-header">Informacje o grze</div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <p>Liczba graczy: <span id="player-count">0</span></p>
                            <p>Zdobyte nagrody: <span id="correct-answers">0</span></p>
                            <p>Język: <span id="language-host">Polski</span></p>
                        </div>
                        <div class="col-md-4">
                            <p>Czas do końca: <span id="time-left" class="timer-display">00:00</span></p>
                            <p>Czas gry (netto): <span id="time-elapsed" class="timer-display">00:00</span></p>
                            <p>Czas gry (brutto): <span id="time-elapsed-pauses" class="timer-display">00:00</span></p>
                        </div>
                        <div class="col-md-4">
                            <p>Aktualna premia: <span id="bonus-multiplier">Brak</span></p>
                            <p>Aktualne tempo: <span id="time-speed">x1</span></p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card mb-3">
                <div class="card-header">Ustawienia przed grą</div>
                <div class="card-body">
                    <form id="start-game-form">
                        <div class="form-group">
                            <label>Czas gry w minutach:</label>
                            <input type="number" class="form-control" id="game-minutes" value="30" min="1">
                        </div>
                        <div class="form-group">
                            <label>Język graczy</label>
                            <select class="form-control" id="language-player">
                                <option value="pl">Język polski</option>
                                <option value="en">Język angielski</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Język prowadzącego</label>
                            <select class="form-control" id="language-host-select">
                                <option value="pl">Język polski</option>
                                <option value="en">Język angielski</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-success">Start Gry</button>
                    </form>
                </div>
            </div>

            <div class="card">
                <div class="card-header">Ustawienia w czasie gry</div>
                <div class="card-body">
                    <div class="form-group">
                        <label>Premia punktowa:</label>
                        <div class="btn-group" id="bonus-buttons">
                            <button class="btn btn-secondary" data-value="2">x2</button>
                            <button class="btn btn-secondary" data-value="3">x3</button>
                            <button class="btn btn-secondary" data-value="10">x10</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Tempo czasu:</label>
                        <div class="btn-group" id="speed-buttons">
                            <button class="btn btn-secondary" data-value="2">x2</button>
                            <button class="btn btn-secondary" data-value="3">x3</button>
                            <button class="btn btn-secondary" data-value="10">x10</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <button class="btn btn-warning" id="pause-game">Pauza</button>
                        <button class="btn btn-danger" id="force-win">Przedwczesna wygrana</button>
                        <button class="btn btn-danger" id="stop-game">Stop Gry</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane" id="players">
            <!-- Player management content here -->
        </div>

        <div class="tab-pane" id="questions">
            <!-- Question management content here -->
        </div>

        {% if event.is_superhost %}
            <div class="tab-pane" id="qrcodes">
                <!-- QR codes content here -->
            </div>
        {% endif %}
    </div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.0/socket.io.min.js"></script>
<script>
    const socket = io();
    const eventId = {{ event.id }};

    // Format seconds to MM:SS
    function formatTime(seconds) {
        if (!seconds || seconds < 0) return '00:00';
        const minutes = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60);
        return `${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    }

    // Join the event room
    socket.emit('join', { event_id: eventId });

    // Update game state
    socket.on('game_state_update', function(data) {
        document.getElementById('player-count').textContent = data.player_count || 0;
        document.getElementById('correct-answers').textContent = data.correct_answers || 0;
        document.getElementById('language-host').textContent = data.language_host === 'en' ? 'English' : 'Polski';
        document.getElementById('bonus-multiplier').textContent = data.bonus_multiplier > 1 ? `x${data.bonus_multiplier}` : 'Brak';
        document.getElementById('time-speed').textContent = `x${data.time_speed}`;
        document.getElementById('pause-game').textContent = data.is_timer_running ? 'Pauza' : 'Wznów';
    });

    // Update timer display
    socket.on('timer_tick', function(data) {
        document.getElementById('time-left').textContent = formatTime(data.time_left);
        document.getElementById('time-elapsed').textContent = formatTime(data.time_elapsed);
        document.getElementById('time-elapsed-pauses').textContent = formatTime(data.time_elapsed_with_pauses);
    });

    // Game over handler
    socket.on('game_over', function() {
        alert('Gra zakończona!');
    });

    // Game forced win handler
    socket.on('game_forced_win', function(data) {
        alert(data.message);
    });

    // Start game
    document.getElementById('start-game-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const minutes = document.getElementById('game-minutes').value;
        const languagePlayer = document.getElementById('language-player').value;
        const languageHost = document.getElementById('language-host-select').value;
        fetch('/api/host/start_game', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ minutes, language_player: languagePlayer, language_host: languageHost })
        }).then(response => response.json()).then(data => {
            if (data.message) alert(data.message);
        });
    });

    // Game control buttons
    document.querySelectorAll('#bonus-buttons button, #speed-buttons button').forEach(button => {
        button.addEventListener('click', function() {
            const control = this.parentElement.id === 'bonus-buttons' ? 'bonus' : 'speed';
            const value = this.getAttribute('data-value');
            fetch('/api/host/game_control', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ control, value })
            }).then(response => response.json()).then(data => {
                if (data.message) alert(data.message);
            });
        });
    });

    // Pause/Resume game
    document.getElementById('pause-game').addEventListener('click', function() {
        fetch('/api/host/game_control', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ control: 'pause' })
        }).then(response => response.json());
    });

    // Force win
    document.getElementById('force-win').addEventListener('click', function() {
        fetch('/api/host/game_control', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ control: 'force_win' })
        }).then(response => response.json());
    });

    // Stop game
    document.getElementById('stop-game').addEventListener('click', function() {
        const password = prompt('Podaj hasło eventu:');
        if (password) {
            fetch('/api/host/stop_game', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ password })
            }).then(response => response.json()).then(data => {
                if (data.message) alert(data.message);
                else if (data.error) alert(data.error);
            });
        }
    });
</script>
{% endblock %}
