{% extends 'base.html' %}
{% block title %}Panel Hosta - {{ event.name }}{% endblock %}

{% block styles %}
{{ super() }}
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- Ikony Bootstrap -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">

<style>
    /* --- 1. BAZA LAYOUTU (MAILERLITE STYLE) --- */
    body {
        overflow: hidden; /* Blokujemy scroll całego okna, scrollujemy tylko content */
        background-color: #f5f7fa; /* Jasnoszare tło typowe dla paneli SaaS */
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        margin: 0; padding: 0;
    }

    /* Ukrycie starego navbara z base.html, jeśli istnieje */
    nav.navbar { display: none !important; }

    /* Główny kontener Flexbox */
    #app-wrapper {
        display: flex;
        height: 100vh;
        width: 100%;
    }

    /* --- 2. SIDEBAR (LEWA STRONA) --- */
    #sidebar {
        width: 260px;
        background-color: #ffffff;
        border-right: 1px solid #e2e5e8;
        display: flex;
        flex-direction: column;
        flex-shrink: 0;
        overflow-y: auto;
        z-index: 1000;
        transition: margin-left 0.3s ease;
    }

    .sidebar-header {
        padding: 20px;
        background: #ffffff;
        border-bottom: 1px solid #f0f0f0;
        display: flex;
        align-items: center;
        position: sticky;
        top: 0;
    }

    .sidebar-header h5 { margin: 0; font-weight: 700; color: #333; font-size: 1.1rem; }

    .sidebar-menu { list-style: none; padding: 15px 10px; margin: 0; }
    .sidebar-menu li { margin-bottom: 2px; }

    .sidebar-link {
        display: flex;
        align-items: center;
        padding: 10px 15px;
        color: #5f6368;
        text-decoration: none;
        font-size: 0.95rem;
        font-weight: 500;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .sidebar-link:hover { background-color: #f4f6f8; color: #222; text-decoration: none; }

    /* Styl aktywnej zakładki */
    .sidebar-link.active {
        background-color: #ebf5fa;
        color: #007bff;
        font-weight: 600;
    }

    .sidebar-link i { margin-right: 12px; font-size: 1.1rem; width: 20px; text-align: center; }

    /* --- 3. MAIN CONTENT (PRAWA STRONA) --- */
    #main-content {
        flex-grow: 1;
        background-color: #f5f7fa;
        overflow-y: auto;
        padding: 30px;
        position: relative;
    }

    .content-wrapper { max-width: 1600px; margin: 0 auto; }

    /* Sekcje treści - domyślnie ukryte */
    .content-section { display: none; animation: fadeIn 0.2s ease-out; }
    .content-section.active { display: block; }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(5px); }
        to { opacity: 1; transform: translateY(0); }
    }

    /* --- 4. KOMPONENTY UI (KARTY, TIMERY) --- */
    .panel-card {
        background: #fff;
        border: 1px solid #e2e5e8;
        border-radius: 8px;
        padding: 25px;
        margin-bottom: 25px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.02);
    }

    .section-title {
        font-size: 1.75rem;
        font-weight: 600;
        color: #333;
        margin-bottom: 25px;
        border-bottom: 1px solid #e2e5e8;
        padding-bottom: 15px;
    }

    /* Styl Timerów */
    .timer-display { font-family: 'Courier New', monospace; font-weight: bold; font-size: 2.5rem; }

    /* Statusy gry */
    .status-indicator { display: inline-block; width: 12px; height: 12px; border-radius: 50%; margin-right: 8px; }
    .status-active { background-color: #28a745; }
    .status-paused { background-color: #ffc107; }
    .status-waiting { background-color: #6c757d; }

    /* Pytania */
    .question-item { border: 1px solid #edf0f2; background: #fff; padding: 15px; margin-bottom: 10px; border-radius: 6px; }
    .question-item.active-q { border-left: 5px solid #007bff; background-color: #f8fbff; }

    /* --- 5. MOBILE --- */
    #mobile-menu-toggle {
        display: none; position: fixed; bottom: 20px; right: 20px; z-index: 1100;
        width: 56px; height: 56px; border-radius: 50%; box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        align-items: center; justify-content: center; font-size: 1.4rem;
    }

    @media (max-width: 992px) {
        #sidebar { position: fixed; left: -260px; top: 0; bottom: 0; box-shadow: 5px 0 15px rgba(0,0,0,0.1); }
        #sidebar.open { left: 0; }
        #mobile-menu-toggle { display: flex; }
        #main-content { padding: 15px; }
        #sidebar-overlay {
            display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.4); z-index: 999;
        }
        #sidebar-overlay.visible { display: block; }
    }
</style>
{% endblock %}

{% block content %}
<div id="app-wrapper">

    <!-- SIDEBAR MENU -->
    <nav id="sidebar">
        <div class="sidebar-header">
            <i class="bi bi-grid-1x2-fill text-primary me-2"></i>
            <h5>Host Panel</h5>
        </div>

        <ul class="sidebar-menu">
            <li><a class="sidebar-link active" onclick="showSection('pulpit', this)"><i class="bi bi-speedometer2"></i> Pulpit (Gra)</a></li>
            <li><a class="sidebar-link" onclick="showSection('ustawienia', this)"><i class="bi bi-gear"></i> Ustawienia</a></li>
            <li><a class="sidebar-link" onclick="showSection('czas', this)"><i class="bi bi-stopwatch"></i> Czas i tempo</a></li>
            <li><a class="sidebar-link" onclick="showSection('gracze', this)"><i class="bi bi-people"></i> Gracze</a></li>
            <li><a class="sidebar-link" onclick="showSection('haslo', this)"><i class="bi bi-input-cursor-text"></i> Hasło</a></li>
            <li><a class="sidebar-link" onclick="showSection('wyswietlacz', this)"><i class="bi bi-tv"></i> Wyświetlacz</a></li>
            <li><a class="sidebar-link" onclick="showSection('kody-qr', this)"><i class="bi bi-qr-code"></i> Kody QR</a></li>
            <li><a class="sidebar-link" onclick="showSection('ar', this)"><i class="bi bi-box-seam"></i> AR</a></li>

            <li class="mt-3 mb-1 text-muted text-uppercase small px-3 fw-bold" style="font-size: 0.75rem;">Pytania</li>
            <li><a class="sidebar-link" onclick="showSection('pytania-r1', this)"><i class="bi bi-1-circle"></i> Runda 1</a></li>
            <li><a class="sidebar-link" onclick="showSection('pytania-r2', this)"><i class="bi bi-2-circle"></i> Runda 2</a></li>
            <li><a class="sidebar-link" onclick="showSection('pytania-r3', this)"><i class="bi bi-3-circle"></i> Runda 3</a></li>

            <li class="mt-3 mb-1 text-muted text-uppercase small px-3 fw-bold" style="font-size: 0.75rem;">Dodatki</li>
            <li><a class="sidebar-link" onclick="showSection('ai', this)"><i class="bi bi-cpu"></i> AI</a></li>
            <li><a class="sidebar-link" onclick="showSection('wrozka', this)"><i class="bi bi-magic"></i> Wróżka AI</a></li>
            <li><a class="sidebar-link" onclick="showSection('minigry', this)"><i class="bi bi-joystick"></i> Minigry</a></li>
            <li><a class="sidebar-link" onclick="showSection('foto', this)"><i class="bi bi-camera"></i> Foto</a></li>
            <li><a class="sidebar-link" onclick="showSection('glosowanie', this)"><i class="bi bi-bar-chart"></i> Głosowanie</a></li>
            <li><a class="sidebar-link" onclick="showSection('na-zywo', this)"><i class="bi bi-activity"></i> Na żywo</a></li>
        </ul>

        <div class="mt-auto p-3 bg-light border-top">
            <small class="text-muted d-block mb-1">Zalogowany:</small>
            <div class="d-flex justify-content-between align-items-center">
                <strong>{{ current_user_id if current_user_id else 'Host' }}</strong>
                <a href="{{ url_for('index') }}" class="btn btn-sm btn-outline-danger"><i class="bi bi-box-arrow-right"></i></a>
            </div>
        </div>
    </nav>

    <!-- Overlay dla mobile -->
    <div id="sidebar-overlay" onclick="toggleMobileMenu()"></div>

    <!-- ================================================================================== -->
    <!-- CZĘŚĆ 2: CONTENT - START -->
    <!-- ================================================================================== -->
    <main id="main-content">
        <div class="content-wrapper">

            <!-- 1. PULPIT -->
            <div id="pulpit" class="content-section active">
                <h2 class="section-title">Pulpit Gry</h2>
                <div class="row g-4">
                    <!-- Karta Statusu -->
                    <div class="col-xl-8 col-lg-7">
                        <div class="panel-card h-100">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <div>
                                    <small class="text-muted text-uppercase">Status Systemu</small>
                                    <h2 class="mb-0 mt-1" id="info-game-status">
                                        <span class="status-indicator status-waiting"></span>Oczekiwanie
                                    </h2>
                                </div>
                                <span class="badge bg-light text-dark border p-2" id="active-round-badge">Runda: Brak</span>
                            </div>

                            <div class="d-flex gap-3 my-4">
                                <button id="start-game-btn" class="btn btn-lg btn-success flex-grow-1"><i class="bi bi-play-fill"></i> START</button>
                                <button id="pause-game-btn" class="btn btn-lg btn-warning flex-grow-1" style="display:none;"><i class="bi bi-pause-fill"></i> PAUZA</button>
                                <button id="stop-game-btn" class="btn btn-lg btn-outline-danger flex-grow-1" style="display:none;"><i class="bi bi-stop-fill"></i> STOP</button>
                            </div>

                            <div class="alert alert-info d-flex align-items-center justify-content-between m-0">
                                <div class="text-truncate me-2">
                                    <i class="bi bi-link-45deg fs-5 me-2"></i>
                                    <strong>{{ url_for('player_join', event_id=event.id, _external=True) }}</strong>
                                </div>
                                <button class="btn btn-sm btn-primary" onclick="copyLink()">Kopiuj</button>
                            </div>
                        </div>
                    </div>

                    <!-- Karta Czasu -->
                    <div class="col-xl-4 col-lg-5">
                        <div class="panel-card h-100 text-center">
                            <small class="text-muted text-uppercase">Czas Rozgrywki</small>
                            <div class="timer-display text-dark my-3" id="info-time-elapsed">00:00:00</div>
                            <p class="text-muted small mb-4">Pauzy łącznie: <span id="info-time-elapsed-pauses">0s</span></p>

                            <div class="border-top pt-3">
                                <small class="text-muted">Odliczanie aktywnego pytania</small>
                                <div class="h2 text-danger fw-bold" id="info-time-left">--:--</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 2. USTAWIENIA -->
            <div id="ustawienia" class="content-section">
                <h2 class="section-title">Ustawienia</h2>
                <div class="panel-card">
                    <form>
                        <div class="mb-3">
                            <label class="form-label">Nazwa Wydarzenia</label>
                            <input type="text" class="form-control" value="{{ event.name }}" readonly>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">ID Wydarzenia</label>
                            <input type="text" class="form-control font-monospace" value="{{ event.id }}" readonly>
                        </div>
                    </form>
                </div>
            </div>

            <!-- 3. CZAS I TEMPO -->
            <div id="czas" class="content-section">
                <h2 class="section-title">Czas i Tempo</h2>
                <div class="row g-4">
                    <div class="col-md-6">
                        <div class="panel-card">
                            <h5 class="mb-3">Timer: Runda 2</h5>
                            <div class="input-group mb-3">
                                <input type="number" id="r2-questions-timer-minutes" class="form-control" placeholder="Min" value="15">
                                <button class="btn btn-primary" id="r2-questions-timer-start">Start</button>
                            </div>
                            <div id="r2-questions-timer-display" class="alert alert-warning text-center display-6 fw-bold" style="display:none;">00:00</div>
                            <button class="btn btn-outline-danger w-100 mt-2" id="r2-questions-timer-cancel" style="display:none;">Anuluj</button>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="panel-card">
                            <h5 class="mb-3">Timer: Runda 3</h5>
                            <div class="input-group mb-3">
                                <input type="number" id="r3-questions-timer-minutes" class="form-control" placeholder="Min" value="10">
                                <button class="btn btn-primary" id="r3-questions-timer-start">Start</button>
                            </div>
                            <div id="r3-questions-timer-display" class="alert alert-warning text-center display-6 fw-bold" style="display:none;">00:00</div>
                            <button class="btn btn-outline-danger w-100 mt-2" id="r3-questions-timer-cancel" style="display:none;">Anuluj</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 4. GRACZE -->
            <div id="gracze" class="content-section">
                <h2 class="section-title">Lista Graczy</h2>
                <div class="panel-card p-0 overflow-hidden">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="bg-light">
                                <tr>
                                    <th class="ps-4">#</th>
                                    <th>Gracz</th>
                                    <th>ID</th>
                                    <th class="text-end">Punkty</th>
                                    <th class="text-center pe-4">Akcje</th>
                                </tr>
                            </thead>
                            <tbody id="players-table-body">
                                <tr><td colspan="5" class="text-center py-5 text-muted">Ładowanie listy graczy...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 5. HASŁO -->
            <div id="haslo" class="content-section">
                <h2 class="section-title">Hasło (Runda 2)</h2>
                <div class="panel-card text-center">
                    <p class="text-muted mb-4">Kliknij literę, aby odsłonić ją na ekranie głównym.</p>
                    <div id="password-reveal-container" class="d-flex flex-wrap justify-content-center gap-2 mb-5">
                        <!-- Generowane przez JS -->
                    </div>
                    <button id="reveal-password-full-btn" class="btn btn-warning px-4 fw-bold">
                        <i class="bi bi-eye-fill"></i> Odsłoń Całe Hasło
                    </button>
                </div>
            </div>

            <!-- 6. WYŚWIETLACZ -->
            <div id="wyswietlacz" class="content-section">
                <h2 class="section-title">Sterowanie Ekranem</h2>
                <div class="panel-card">
                    <div class="row g-3 mb-4">
                        <div class="col-md-4">
                            <button class="btn btn-outline-primary w-100 p-4" onclick="sendScreenAction('show_logo')">
                                <i class="bi bi-card-image fs-1 d-block mb-2"></i> Logo
                            </button>
                        </div>
                        <div class="col-md-4">
                            <button class="btn btn-outline-success w-100 p-4" onclick="sendScreenAction('show_ranking')">
                                <i class="bi bi-trophy fs-1 d-block mb-2"></i> Ranking
                            </button>
                        </div>
                        <div class="col-md-4">
                            <button class="btn btn-outline-dark w-100 p-4" onclick="sendScreenAction('black_screen')">
                                <i class="bi bi-display fs-1 d-block mb-2"></i> Czarny Ekran
                            </button>
                        </div>
                    </div>
                    <hr>
                    <h5 class="mb-3">Komunikat Globalny</h5>
                    <div class="input-group">
                        <input type="text" id="global-message-input" class="form-control" placeholder="Wiadomość dla wszystkich...">
                        <button class="btn btn-primary" id="send-global-message-btn">Wyślij</button>
                    </div>
                </div>
            </div>

            <!-- 7. KODY QR -->
            <div id="kody-qr" class="content-section">
                <h2 class="section-title">Kody QR</h2>
                <div class="panel-card text-center">
                    <div class="row justify-content-center">
                        <div class="col-md-6 col-lg-4">
                            <div class="border rounded p-4 bg-white">
                                <img src="https://api.qrserver.com/v1/create-qr-code/?size=250x250&data={{ url_for('player_join', event_id=event.id, _external=True) }}" class="img-fluid mb-3" alt="QR">
                                <h5 class="mb-2">Dołącz do gry</h5>
                                <a href="{{ url_for('player_join', event_id=event.id, _external=True) }}" target="_blank" class="text-decoration-none">{{ event.id }}</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 8. AR -->
            <div id="ar" class="content-section">
                <h2 class="section-title">Rzeczywistość Rozszerzona (AR)</h2>
                <div class="panel-card">
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle"></i> Moduł AR wymaga dostępu do kamery i konfiguracji backendu (OpenCV).
                    </div>
                    <!-- Miejsce na podgląd wideo -->
                    <div id="video_container" class="bg-dark text-white d-flex align-items-center justify-content-center" style="height: 400px; border-radius: 8px;">
                        <span class="text-muted">Podgląd kamery niedostępny</span>
                    </div>
                </div>
            </div>

            <!-- 9. PYTANIA RUNDA 1 -->
            <div id="pytania-r1" class="content-section">
                <h2 class="section-title">Runda 1: Pytania ABC</h2>
                <div id="questions-r1-container">
                    {% for q in questions_r1 %}
                    <div class="question-item" id="q-r1-{{ q.id }}">
                        <div class="d-flex justify-content-between">
                            <div class="flex-grow-1">
                                <h5 class="mb-2"><span class="badge bg-secondary me-2">{{ loop.index }}</span> {{ q.question_text }}</h5>
                                <div class="d-flex flex-wrap gap-2 mb-2">
                                    <span class="badge bg-light text-dark border">A: {{ q.option_a }}</span>
                                    <span class="badge bg-light text-dark border">B: {{ q.option_b }}</span>
                                    <span class="badge bg-light text-dark border">C: {{ q.option_c }}</span>
                                    <span class="badge bg-light text-dark border">D: {{ q.option_d }}</span>
                                </div>
                                <div class="small text-muted">Poprawna: <strong>{{ q.correct_answer }}</strong> | Czas: {{ q.time_limit }}s</div>
                            </div>
                            <div class="d-flex flex-column gap-2 ms-3">
                                <button class="btn btn-sm btn-primary activate-q-btn" data-qid="{{ q.id }}" data-type="r1">Aktywuj</button>
                                <button class="btn btn-sm btn-outline-secondary reveal-q-btn" data-qid="{{ q.id }}" disabled>Pokaż Odp.</button>
                                <button class="btn btn-sm btn-outline-danger close-q-btn" data-qid="{{ q.id }}" disabled>Zakończ</button>
                            </div>
                        </div>
                        <div class="mt-3">
                            <div class="progress" style="height: 8px;">
                                <div class="progress-bar bg-success" id="progress-q-{{ q.id }}" role="progressbar" style="width: 0%"></div>
                            </div>
                            <small class="text-muted d-block mt-1 text-end" id="answers-count-{{ q.id }}">Odpowiedzi: 0</small>
                        </div>
                    </div>
                    {% else %}
                    <div class="alert alert-light text-center">Brak pytań dla Rundy 1.</div>
                    {% endfor %}
                </div>
            </div>

            <!-- 10. PYTANIA RUNDA 2 -->
            <div id="pytania-r2" class="content-section">
                <h2 class="section-title">Runda 2: Pytania Otwarte</h2>
                <div id="questions-r2-container">
                    {% for q in questions_r2 %}
                    <div class="question-item" id="q-r2-{{ q.id }}">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h5 class="mb-1">{{ loop.index }}. {{ q.question_text }}</h5>
                                <small class="text-muted">Odp: {{ q.correct_answer }}</small>
                            </div>
                            <button class="btn btn-primary activate-q-btn" data-qid="{{ q.id }}" data-type="r2">Zadaj</button>
                        </div>
                    </div>
                    {% else %}
                    <div class="alert alert-light text-center">Brak pytań dla Rundy 2.</div>
                    {% endfor %}
                </div>
            </div>

            <!-- 11. PYTANIA RUNDA 3 -->
            <div id="pytania-r3" class="content-section">
                <h2 class="section-title">Runda 3: Finał</h2>
                <div id="questions-r3-container">
                    {% for q in questions_r3 %}
                    <div class="question-item" id="q-r3-{{ q.id }}">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h5 class="mb-1">{{ loop.index }}. {{ q.question_text }}</h5>
                                <small class="text-muted">Odp: {{ q.correct_answer }}</small>
                            </div>
                            <button class="btn btn-primary activate-q-btn" data-qid="{{ q.id }}" data-type="r3">Zadaj</button>
                        </div>
                    </div>
                    {% else %}
                    <div class="alert alert-light text-center">Brak pytań dla Rundy 3.</div>
                    {% endfor %}
                </div>
            </div>

            <!-- 12. AI -->
            <div id="ai" class="content-section">
                <h2 class="section-title">Generator AI</h2>
                <div class="panel-card">
                    <div class="input-group mb-3">
                        <span class="input-group-text">Temat</span>
                        <input type="text" class="form-control" placeholder="np. Historia komputerów w Polsce">
                        <button class="btn btn-purple text-white" style="background-color: #6610f2;">Generuj</button>
                    </div>
                    <div class="alert alert-secondary">Tu pojawią się wygenerowane pytania.</div>
                </div>
            </div>

            <!-- 13. WRÓŻKA AI -->
            <div id="wrozka" class="content-section">
                <h2 class="section-title">Wróżka AI</h2>
                <div class="panel-card text-center py-5">
                    <i class="bi bi-stars text-warning display-1 mb-3"></i>
                    <h3>Panel Wróżki</h3>
                    <p class="text-muted">Interakcje z modułem wróżki pojawią się tutaj.</p>
                </div>
            </div>

            <!-- 14. MINIGRY -->
            <div id="minigry" class="content-section">
                <h2 class="section-title">Minigry</h2>
                <div class="row">
                    <div class="col-md-4">
                        <div class="panel-card text-center">
                            <i class="bi bi-pie-chart fs-1 text-primary mb-2"></i>
                            <h5>Koło Fortuny</h5>
                            <button class="btn btn-sm btn-outline-primary mt-2">Uruchom</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 15. FOTO -->
            <div id="foto" class="content-section">
                <h2 class="section-title">Galeria Foto</h2>
                <div class="panel-card">
                    <div class="alert alert-light border text-center py-4">Galeria jest pusta.</div>
                </div>
            </div>

            <!-- 16. GŁOSOWANIE -->
            <div id="glosowanie" class="content-section">
                <h2 class="section-title">Głosowanie</h2>
                <div class="panel-card">
                    <button class="btn btn-primary"><i class="bi bi-plus-lg"></i> Utwórz Głosowanie</button>
                </div>
            </div>

            <!-- 17. NA ŻYWO -->
            <div id="na-zywo" class="content-section">
                <h2 class="section-title">Logi Systemowe</h2>
                <div class="bg-dark text-light p-3 rounded font-monospace" id="live-logs" style="height: 400px; overflow-y: auto; font-size: 0.85rem;">
                    <div class="text-success">> System uruchomiony poprawnie.</div>
                    <div class="text-muted">> Oczekiwanie na połączenia...</div>
                </div>
            </div>

        </div>
    </main>
</div>

<!-- Przycisk Menu Mobilnego -->
<button id="mobile-menu-toggle" class="btn btn-primary" onclick="toggleMobileMenu()">
    <i class="bi bi-list"></i>
</button>

{% endblock %}

<!-- ================================================================================== -->
<!-- CZĘŚĆ 3: SKRYPTY (LOGIKA GRY I NAWIGACJI) -->
<!-- ================================================================================== -->
{% block scripts %}
{{ super() }}
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
<script>
    // --- ZMIENNE GLOBALNE ---
    const socket = io();
    const eventId = "{{ event.id }}";
    let gameTimerInterval, r2TimerInterval, r3TimerInterval;
    let gameStartTime = null, totalPausedDuration = 0, isPaused = false;
    let r2TimerEndTime = null, r3TimerEndTime = null;

    // --- 1. NAWIGACJA (TAB SWITCHER) ---
    function showSection(sectionId, element) {
        document.querySelectorAll('.content-section').forEach(el => el.classList.remove('active'));
        const target = document.getElementById(sectionId);
        if (target) target.classList.add('active');

        document.querySelectorAll('.sidebar-link').forEach(el => el.classList.remove('active'));
        if (element) element.classList.add('active');

        if (window.innerWidth <= 992) toggleMobileMenu();
    }

    function toggleMobileMenu() {
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('sidebar-overlay');
        sidebar.classList.toggle('open');
        overlay.classList.toggle('visible');
    }

    function copyLink() {
        const link = "{{ url_for('player_join', event_id=event.id, _external=True) }}";
        if (navigator.clipboard) {
            navigator.clipboard.writeText(link).then(() => alert('Skopiowano link!'));
        } else {
            const el = document.createElement('textarea');
            el.value = link;
            document.body.appendChild(el);
            el.select();
            document.execCommand('copy');
            document.body.removeChild(el);
            alert('Skopiowano link!');
        }
    }

    // --- 2. LOGIKA SOCKET.IO ---
    socket.on('connect', () => {
        console.log('Połączono z Socket.IO');
        socket.emit('join', { room: eventId });
        logAction('Połączono z serwerem gry.');
    });

    socket.on('game_status_update', updateGameStatusUI);
    socket.on('players_update', renderPlayersTable);

    function logAction(msg) {
        const logs = document.getElementById('live-logs');
        const div = document.createElement('div');
        div.textContent = `> ${new Date().toLocaleTimeString()} ${msg}`;
        logs.prepend(div);
    }

    // --- 3. OBSŁUGA STANU GRY (Status, Timery) ---
    function updateGameStatusUI(data) {
        const statusEl = document.getElementById('info-game-status');
        const startBtn = document.getElementById('start-game-btn');
        const pauseBtn = document.getElementById('pause-game-btn');
        const stopBtn = document.getElementById('stop-game-btn');
        const badge = document.getElementById('active-round-badge');

        if (data.status === 'active') {
            statusEl.innerHTML = '<span class="status-indicator status-active"></span>Gra Aktywna';
            startBtn.style.display = 'none';
            pauseBtn.style.display = 'inline-block';
            pauseBtn.innerHTML = '<i class="bi bi-pause-fill"></i> PAUZA';
            stopBtn.style.display = 'inline-block';
            isPaused = false;
            if (data.start_time) {
                gameStartTime = new Date(data.start_time);
                totalPausedDuration = (data.total_paused_seconds || 0) * 1000;
                if (!gameTimerInterval) gameTimerInterval = setInterval(updateMainTimer, 1000);
            }
        } else if (data.status === 'paused') {
            statusEl.innerHTML = '<span class="status-indicator status-paused"></span>Pauza';
            pauseBtn.innerHTML = '<i class="bi bi-play-fill"></i> WZNÓW';
            isPaused = true;
        } else {
            statusEl.innerHTML = '<span class="status-indicator status-waiting"></span>Oczekiwanie';
            startBtn.style.display = 'inline-block';
            pauseBtn.style.display = 'none';
            stopBtn.style.display = 'none';
            clearInterval(gameTimerInterval);
            gameTimerInterval = null;
        }

        badge.textContent = data.active_round ? `Runda ${data.active_round}` : 'Runda: Brak';
    }

    function updateMainTimer() {
        if (!gameStartTime || isPaused) return;
        const now = new Date();
        const diff = now - gameStartTime - totalPausedDuration;
        if (diff < 0) return;
        const h = Math.floor(diff / 3600000).toString().padStart(2, '0');
        const m = Math.floor((diff % 3600000) / 60000).toString().padStart(2, '0');
        const s = Math.floor((diff % 60000) / 1000).toString().padStart(2, '0');
        document.getElementById('info-time-elapsed').textContent = `${h}:${m}:${s}`;
    }

    document.getElementById('start-game-btn').onclick = () => fetch(`/api/host/game/start/${eventId}`, { method: 'POST' });
    document.getElementById('stop-game-btn').onclick = () => { if(confirm('Stop?')) fetch(`/api/host/game/stop/${eventId}`, { method: 'POST' }); };
    document.getElementById('pause-game-btn').onclick = () => {
        const endpoint = isPaused ? 'resume' : 'pause';
        fetch(`/api/host/game/${endpoint}/${eventId}`, { method: 'POST' });
    };

    // --- 4. OBSŁUGA PYTAŃ ---
    document.querySelectorAll('.activate-q-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const qid = this.dataset.qid;
            const type = this.dataset.type;
            fetch(`/api/host/question/activate/${eventId}/${qid}`, { method: 'POST' })
                .then(r => r.json())
                .then(res => {
                    if(res.status === 'success') {
                        logAction(`Aktywowano pytanie ${qid} (${type})`);
                        if(type === 'r1') {
                            document.querySelectorAll('.question-item').forEach(qi => qi.classList.remove('active-q'));
                            const parent = document.getElementById(`q-r1-${qid}`);
                            parent.classList.add('active-q');
                            parent.querySelector('.activate-q-btn').disabled = true;
                            parent.querySelector('.reveal-q-btn').disabled = false;
                            parent.querySelector('.close-q-btn').disabled = false;
                        }
                    }
                });
        });
    });

    document.querySelectorAll('.reveal-q-btn').forEach(btn => {
        btn.onclick = function() { fetch(`/api/host/question/reveal/${eventId}/${this.dataset.qid}`, { method: 'POST' }); }
    });

    // --- 5. GRACZE ---
    function renderPlayersTable(players) {
        const tbody = document.getElementById('players-table-body');
        tbody.innerHTML = '';
        players.sort((a, b) => b.score - a.score);
        players.forEach((p, index) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td class="ps-4 fw-bold text-muted">${index + 1}</td>
                <td><span class="fw-bold">${p.name}</span></td>
                <td class="text-muted small font-monospace">${p.id.substring(0, 6)}</td>
                <td class="text-end fw-bold text-primary">${p.score}</td>
                <td class="text-center pe-4"><button class="btn btn-sm btn-outline-danger" onclick="kickPlayer('${p.id}')"><i class="bi bi-x-lg"></i></button></td>
            `;
            tbody.appendChild(tr);
        });
    }

    window.kickPlayer = (pid) => {
        if(confirm('Usunąć gracza?')) console.log('Kick:', pid); // Tu dodaj fetch
    };

    // --- 6. TIMERY RUND (Zgodne z Twoim kodem) ---
    async function checkActiveTimers() {
        try {
            // R2
            const r2Res = await fetch(`/api/host/questions_r2/timer/${eventId}`);
            if (r2Res.ok) {
                const d = await r2Res.json();
                if (d.active && d.end_time) {
                    r2TimerEndTime = new Date(d.end_time);
                    startTimerUI('r2', r2TimerEndTime);
                }
            }
            // R3
            const r3Res = await fetch(`/api/host/questions_r3/timer/${eventId}`);
            if (r3Res.ok) {
                const d = await r3Res.json();
                if (d.active && d.end_time) {
                    r3TimerEndTime = new Date(d.end_time);
                    startTimerUI('r3', r3TimerEndTime);
                }
            }
        } catch (e) { console.error(e); }
    }

    function startTimerUI(prefix, endTime) {
        const display = document.getElementById(`${prefix}-questions-timer-display`);
        const cancelBtn = document.getElementById(`${prefix}-questions-timer-cancel`);
        display.style.display = 'block';
        cancelBtn.style.display = 'inline-block';

        const interval = setInterval(() => {
            const now = new Date();
            const left = Math.ceil((endTime - now) / 1000);
            if (left <= 0) {
                display.textContent = "KONIEC";
                display.classList.add('bg-danger', 'text-white');
                clearInterval(interval);
            } else {
                const m = Math.floor(left / 60).toString().padStart(2, '0');
                const s = (left % 60).toString().padStart(2, '0');
                display.textContent = `${m}:${s}`;
            }
        }, 1000);

        if(prefix === 'r2') r2TimerInterval = interval;
        if(prefix === 'r3') r3TimerInterval = interval;
    }

    // Handlery przycisków timerów
    document.getElementById('r2-questions-timer-start').onclick = () => {
        const min = document.getElementById('r2-questions-timer-minutes').value;
        fetch(`/api/host/questions_r2/timer/start/${eventId}`, {
            method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({minutes: min})
        }).then(r=>r.json()).then(d => { if(d.end_time) startTimerUI('r2', new Date(d.end_time)); });
    };
    document.getElementById('r2-questions-timer-cancel').onclick = () => {
        fetch(`/api/host/questions_r2/timer/stop/${eventId}`, { method: 'POST' }).then(() => location.reload());
    };
    // Powtórz to samo dla R3...
    document.getElementById('r3-questions-timer-start').onclick = () => {
        const min = document.getElementById('r3-questions-timer-minutes').value;
        fetch(`/api/host/questions_r3/timer/start/${eventId}`, {
            method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({minutes: min})
        }).then(r=>r.json()).then(d => { if(d.end_time) startTimerUI('r3', new Date(d.end_time)); });
    };
    document.getElementById('r3-questions-timer-cancel').onclick = () => {
        fetch(`/api/host/questions_r3/timer/stop/${eventId}`, { method: 'POST' }).then(() => location.reload());
    };

    // Inicjalizacja
    checkActiveTimers();
    fetch(`/api/host/game/status/${eventId}`).then(r=>r.json()).then(data => updateGameStatusUI(data));

    window.sendScreenAction = (action) => {
        socket.emit('screen_control', { action: action, room: eventId });
        logAction(`Ekran: ${action}`);
    };

    document.getElementById('send-global-message-btn').onclick = () => {
        const msg = document.getElementById('global-message-input').value;
        if(msg) {
            socket.emit('admin_message', { room: eventId, message: msg });
            document.getElementById('global-message-input').value = '';
            alert('Wysłano!');
        }
    };
</script>
{% endblock %}
