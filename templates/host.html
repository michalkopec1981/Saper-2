{% extends 'base.html' %}
{% block title %}Panel Hosta - {{ event.name }}{% endblock %}

{% block styles %}
{{ super() }}
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
<style>
    /* --- LAYOUT W STYLU MAILERLITE --- */
    body {
        overflow: hidden; /* Zapobiegamy paskom przewijania na body */
        background-color: #f5f7fa;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        margin: 0;
        padding: 0;
    }

    /* Główny kontener aplikacji - zajmuje całą dostępną wysokość */
    #app-wrapper {
        display: flex;
        height: 100vh;
        width: 100%;
        overflow: hidden;
    }

    /* Jeśli base.html ma navbar, trzeba go ukryć dla czystego layoutu */
    nav.navbar {
        display: none !important;
    }

    /* --- SIDEBAR (LEWA STRONA) --- */
    #sidebar {
        width: 260px;
        background-color: #ffffff;
        border-right: 1px solid #e2e5e8;
        display: flex;
        flex-direction: column;
        flex-shrink: 0;
        z-index: 1000;
        height: 100%;
        overflow-y: auto;
        transition: margin-left 0.3s ease;
    }

    .sidebar-header {
        padding: 20px;
        background: #ffffff;
        border-bottom: 1px solid #f0f0f0;
        display: flex;
        align-items: center;
        position: sticky;
        top: 0;
        z-index: 10;
    }

    .sidebar-header h5 {
        margin: 0;
        font-weight: 700;
        color: #333;
        font-size: 1.1rem;
    }

    .sidebar-menu {
        list-style: none;
        padding: 15px 10px;
        margin: 0;
    }

    .sidebar-menu li {
        margin-bottom: 4px;
    }

    .sidebar-link {
        display: flex;
        align-items: center;
        padding: 10px 15px;
        color: #5f6368;
        text-decoration: none;
        font-size: 0.95rem;
        font-weight: 500;
        border-radius: 6px;
        transition: all 0.2s ease;
        cursor: pointer;
    }

    .sidebar-link:hover {
        background-color: #f4f6f8;
        color: #222;
        text-decoration: none;
    }

    .sidebar-link.active {
        background-color: #ebf5fa; /* Jasny niebieski akcent */
        color: #007bff; /* Kolor MailerLite / Bootstrap Primary */
        font-weight: 600;
    }

    .sidebar-link i {
        margin-right: 12px;
        font-size: 1.1rem;
        width: 20px;
        text-align: center;
    }

    /* --- GŁÓWNA ZAWARTOŚĆ (PRAWA STRONA) --- */
    #main-content {
        flex-grow: 1;
        background-color: #f5f7fa;
        overflow-y: auto;
        padding: 30px;
        height: 100%;
        position: relative;
    }

    /* Kontener na treść wewnątrz main-content */
    .content-wrapper {
        max-width: 1400px; /* Szeroki widok, ale z limitem */
        margin: 0 auto;
    }

    .content-section {
        display: none; /* Domyślnie ukryte */
        animation: fadeIn 0.2s ease-out;
    }

    .content-section.active {
        display: block;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(5px); }
        to { opacity: 1; transform: translateY(0); }
    }

    /* Karty w stylu panelu */
    .panel-card {
        background: #fff;
        border: 1px solid #e2e5e8;
        border-radius: 8px;
        padding: 25px;
        margin-bottom: 25px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.02);
    }

    .section-title {
        font-size: 1.75rem;
        font-weight: 600;
        color: #333;
        margin-bottom: 25px;
        border-bottom: 1px solid #e2e5e8;
        padding-bottom: 15px;
    }

    /* --- STYLIZACJA ELEMENTÓW GRY --- */
    .timer-display {
        font-family: 'Courier New', monospace;
        font-weight: bold;
        font-size: 2.5rem;
    }

    .status-indicator {
        display: inline-block;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        margin-right: 8px;
    }
    .status-active { background-color: #28a745; }
    .status-paused { background-color: #ffc107; }
    .status-waiting { background-color: #6c757d; }

    .question-item {
        border: 1px solid #edf0f2;
        background: #fff;
        padding: 15px;
        margin-bottom: 10px;
        border-radius: 6px;
        transition: box-shadow 0.2s;
    }
    .question-item:hover {
        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }
    .question-item.active-q {
        border-left: 4px solid #007bff;
        background-color: #f8fbff;
    }

    /* --- MENU MOBILNE --- */
    #mobile-menu-toggle {
        display: none;
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 1100;
        width: 56px;
        height: 56px;
        border-radius: 50%;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        align-items: center;
        justify-content: center;
        font-size: 1.4rem;
    }

    @media (max-width: 992px) {
        #sidebar {
            position: fixed;
            left: -260px; /* Schowany */
            top: 0;
            bottom: 0;
            box-shadow: 5px 0 15px rgba(0,0,0,0.1);
        }
        #sidebar.open {
            left: 0;
        }
        #mobile-menu-toggle {
            display: flex;
        }
        #main-content {
            padding: 15px;
        }
        /* Overlay tła */
        #sidebar-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.4);
            z-index: 999;
        }
        #sidebar-overlay.visible {
            display: block;
        }
    }
</style>
{% endblock %}

{% block content %}
<div id="app-wrapper">

    <!-- 1. SIDEBAR (PASEK BOCZNY) -->
    <nav id="sidebar">
        <div class="sidebar-header">
            <i class="bi bi-grid-1x2-fill text-primary me-2"></i>
            <h5>Host Panel</h5>
        </div>

        <ul class="sidebar-menu">
            <!-- Zgodnie z Twoją listą -->
            <li><a class="sidebar-link active" onclick="showSection('pulpit', this)"><i class="bi bi-speedometer2"></i> Pulpit (Gra)</a></li>
            <li><a class="sidebar-link" onclick="showSection('ustawienia', this)"><i class="bi bi-gear"></i> Ustawienia</a></li>
            <li><a class="sidebar-link" onclick="showSection('czas', this)"><i class="bi bi-stopwatch"></i> Czas i tempo</a></li>
            <li><a class="sidebar-link" onclick="showSection('gracze', this)"><i class="bi bi-people"></i> Gracze</a></li>
            <li><a class="sidebar-link" onclick="showSection('haslo', this)"><i class="bi bi-input-cursor-text"></i> Hasło</a></li>
            <li><a class="sidebar-link" onclick="showSection('wyswietlacz', this)"><i class="bi bi-tv"></i> Wyświetlacz</a></li>
            <li><a class="sidebar-link" onclick="showSection('kody-qr', this)"><i class="bi bi-qr-code"></i> Kody QR</a></li>
            <li><a class="sidebar-link" onclick="showSection('ar', this)"><i class="bi bi-box-seam"></i> AR</a></li>

            <li class="mt-3 mb-1 text-muted text-uppercase small px-3">Pytania</li>
            <li><a class="sidebar-link" onclick="showSection('pytania-r1', this)"><i class="bi bi-1-circle"></i> Runda 1</a></li>
            <li><a class="sidebar-link" onclick="showSection('pytania-r2', this)"><i class="bi bi-2-circle"></i> Runda 2</a></li>
            <li><a class="sidebar-link" onclick="showSection('pytania-r3', this)"><i class="bi bi-3-circle"></i> Runda 3</a></li>

            <li class="mt-3 mb-1 text-muted text-uppercase small px-3">Dodatki</li>
            <li><a class="sidebar-link" onclick="showSection('ai', this)"><i class="bi bi-cpu"></i> AI</a></li>
            <li><a class="sidebar-link" onclick="showSection('wrozka', this)"><i class="bi bi-magic"></i> Wróżka AI</a></li>
            <li><a class="sidebar-link" onclick="showSection('minigry', this)"><i class="bi bi-joystick"></i> Minigry</a></li>
            <li><a class="sidebar-link" onclick="showSection('foto', this)"><i class="bi bi-camera"></i> Foto</a></li>
            <li><a class="sidebar-link" onclick="showSection('glosowanie', this)"><i class="bi bi-bar-chart"></i> Głosowanie</a></li>
            <li><a class="sidebar-link" onclick="showSection('na-zywo', this)"><i class="bi bi-activity"></i> Na żywo</a></li>
        </ul>

        <div class="mt-auto p-3 bg-light border-top">
            <div class="d-flex align-items-center justify-content-between">
                <div>
                    <small class="text-muted d-block">Zalogowany jako:</small>
                    <strong>{{ current_user_id if current_user_id else 'Host' }}</strong>
                </div>
                <a href="{{ url_for('index') }}" class="btn btn-sm btn-outline-danger"><i class="bi bi-power"></i></a>
            </div>
        </div>
    </nav>

    <!-- Overlay dla mobile -->
    <div id="sidebar-overlay" onclick="toggleMobileMenu()"></div>

    <!-- 2. MAIN CONTENT (OBSZAR ROBOCZY) -->
    <main id="main-content">
        <div class="content-wrapper">

            <!-- SEKCJA: PULPIT (Stara nazwa: Gra) -->
            <div id="pulpit" class="content-section active">
                <h2 class="section-title">Pulpit Gry</h2>

                <div class="row g-4">
                    <!-- Karta Statusu -->
                    <div class="col-xl-8 col-lg-7">
                        <div class="panel-card h-100">
                            <div class="d-flex justify-content-between align-items-start mb-4">
                                <div>
                                    <h5 class="card-title text-muted">Status Rozgrywki</h5>
                                    <h2 class="mb-0" id="info-game-status">
                                        <span class="status-indicator status-waiting"></span>Oczekiwanie
                                    </h2>
                                </div>
                                <div class="text-end">
                                    <span class="badge bg-light text-dark border p-2" id="active-round-badge">Runda: Brak</span>
                                </div>
                            </div>

                            <div class="d-flex gap-3 mt-4">
                                <button id="start-game-btn" class="btn btn-lg btn-success px-5"><i class="bi bi-play-fill"></i> START</button>
                                <button id="pause-game-btn" class="btn btn-lg btn-warning px-4" style="display:none;"><i class="bi bi-pause-fill"></i> PAUZA</button>
                                <button id="stop-game-btn" class="btn btn-lg btn-outline-danger px-4" style="display:none;"><i class="bi bi-stop-fill"></i> STOP</button>
                            </div>

                            <hr class="my-4">
                            <div class="alert alert-info d-flex align-items-center">
                                <i class="bi bi-link-45deg fs-3 me-3"></i>
                                <div class="flex-grow-1 overflow-hidden">
                                    <small>Link dla graczy:</small><br>
                                    <strong class="text-truncate d-block" style="max-width: 100%;">{{ url_for('player_join', event_id=event.id, _external=True) }}</strong>
                                </div>
                                <button class="btn btn-sm btn-primary ms-2" onclick="copyLink()">Kopiuj</button>
                            </div>
                        </div>
                    </div>

                    <!-- Karta Czasu -->
                    <div class="col-xl-4 col-lg-5">
                        <div class="panel-card h-100 text-center d-flex flex-direction-column justify-content-center align-items-center">
                            <h6 class="text-muted mb-3">CZAS GRY</h6>
                            <div class="timer-display text-dark mb-2" id="info-time-elapsed">00:00:00</div>
                            <small class="text-muted">Czas trwania pauzy: <span id="info-time-elapsed-pauses">0s</span></small>

                            <div class="mt-4 w-100 border-top pt-4">
                                <h6 class="text-muted mb-2">Pozostało (aktywne pytanie)</h6>
                                <div class="h2 text-danger fw-bold" id="info-time-left">--:--</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SEKCJA: USTAWIENIA -->
            <div id="ustawienia" class="content-section">
                <h2 class="section-title">Ustawienia</h2>
                <div class="panel-card">
                    <form>
                        <div class="mb-4">
                            <label class="form-label fw-bold">Nazwa Wydarzenia</label>
                            <input type="text" class="form-control form-control-lg" value="{{ event.name }}" readonly>
                            <div class="form-text">ID Wydarzenia: {{ event.id }}</div>
                        </div>
                        <!-- Tutaj miejsce na dodatkowe opcje konfiguracyjne -->
                        <div class="alert alert-secondary">
                            <i class="bi bi-info-circle"></i> Więcej ustawień globalnych dostępnych jest w panelu administratora.
                        </div>
                    </form>
                </div>
            </div>

            <!-- SEKCJA: CZAS I TEMPO -->
            <div id="czas" class="content-section">
                <h2 class="section-title">Czas i Tempo</h2>
                <div class="row">
                    <div class="col-md-6">
                        <div class="panel-card">
                            <h5 class="card-title mb-3">Timer: Runda 2</h5>
                            <div class="input-group mb-3">
                                <input type="number" id="r2-questions-timer-minutes" class="form-control" placeholder="Minuty" value="15">
                                <button class="btn btn-primary" id="r2-questions-timer-start">Ustaw i Start</button>
                            </div>
                            <div id="r2-questions-timer-display" class="alert alert-warning text-center display-4 fw-bold" style="display:none;">00:00</div>
                            <button class="btn btn-outline-danger w-100" id="r2-questions-timer-cancel" style="display:none;">Anuluj Timer</button>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="panel-card">
                            <h5 class="card-title mb-3">Timer: Runda 3</h5>
                            <div class="input-group mb-3">
                                <input type="number" id="r3-questions-timer-minutes" class="form-control" placeholder="Minuty" value="10">
                                <button class="btn btn-primary" id="r3-questions-timer-start">Ustaw i Start</button>
                            </div>
                            <div id="r3-questions-timer-display" class="alert alert-warning text-center display-4 fw-bold" style="display:none;">00:00</div>
                            <button class="btn btn-outline-danger w-100" id="r3-questions-timer-cancel" style="display:none;">Anuluj Timer</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SEKCJA: GRACZE -->
            <div id="gracze" class="content-section">
                <h2 class="section-title">Gracze</h2>
                <div class="panel-card">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>Pozycja</th>
                                    <th>Nazwa Gracza</th>
                                    <th>ID</th>
                                    <th class="text-end">Punkty</th>
                                    <th class="text-center">Akcje</th>
                                </tr>
                            </thead>
                            <tbody id="players-table-body">
                                <!-- Wypełniane dynamicznie przez JS -->
                                <tr><td colspan="5" class="text-center text-muted py-4">Oczekiwanie na dane...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- SEKCJA: HASŁO -->
            <div id="haslo" class="content-section">
                <h2 class="section-title">Hasło (Runda 2)</h2>
                <div class="panel-card text-center">
                    <p class="mb-4">Kliknij na literę poniżej, aby odsłonić ją na ekranie głównym graczy.</p>

                    <!-- Kontener na litery hasła - logika generowania buttonów w JS/Jinja -->
                    <div id="password-reveal-container" class="d-flex flex-wrap justify-content-center gap-2 mb-4">
                        <!-- Tutaj JS wstawia przyciski liter -->
                    </div>

                    <hr>
                    <button id="reveal-password-full-btn" class="btn btn-warning text-dark fw-bold">
                        <i class="bi bi-eye-fill"></i> Odsłoń całe hasło
                    </button>
                </div>
            </div>

            <!-- SEKCJA: WYŚWIETLACZ -->
            <div id="wyswietlacz" class="content-section">
                <h2 class="section-title">Zarządzanie Ekranem</h2>
                <div class="panel-card">
                    <h5 class="mb-3">Tryb Wyświetlania</h5>
                    <div class="row g-3 mb-4">
                        <div class="col-md-4">
                            <button class="btn btn-outline-primary w-100 p-3 h-100" onclick="sendScreenAction('show_logo')">
                                <i class="bi bi-image fs-1 d-block mb-2"></i>
                                Logo Wydarzenia
                            </button>
                        </div>
                        <div class="col-md-4">
                            <button class="btn btn-outline-success w-100 p-3 h-100" onclick="sendScreenAction('show_ranking')">
                                <i class="bi bi-trophy fs-1 d-block mb-2"></i>
                                Tabela Wyników
                            </button>
                        </div>
                        <div class="col-md-4">
                            <button class="btn btn-outline-dark w-100 p-3 h-100" onclick="sendScreenAction('black_screen')">
                                <i class="bi bi-display fs-1 d-block mb-2"></i>
                                Czarny Ekran
                            </button>
                        </div>
                    </div>

                    <h5 class="mb-3">Komunikat Globalny</h5>
                    <div class="input-group">
                        <input type="text" id="global-message-input" class="form-control" placeholder="Wpisz wiadomość dla wszystkich graczy...">
                        <button class="btn btn-primary" id="send-global-message-btn">Wyślij Wiadomość</button>
                    </div>
                </div>
            </div>

            <!-- SEKCJA: KODY QR -->
            <div id="kody-qr" class="content-section">
                <h2 class="section-title">Kody QR</h2>
                <div class="panel-card text-center">
                    <div class="row justify-content-center">
                        <div class="col-md-6">
                            <div class="card shadow-sm">
                                <div class="card-body p-4">
                                    <h5 class="card-title">Dołącz do gry</h5>
                                    <img src="https://api.qrserver.com/v1/create-qr-code/?size=250x250&data={{ url_for('player_join', event_id=event.id, _external=True) }}" class="img-fluid my-3" alt="QR Code">
                                    <p class="card-text text-muted small">{{ url_for('player_join', event_id=event.id, _external=True) }}</p>
                                    <a href="{{ url_for('player_join', event_id=event.id, _external=True) }}" target="_blank" class="btn btn-outline-primary btn-sm">Otwórz w nowej karcie</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SEKCJA: AR -->
            <div id="ar" class="content-section">
                <h2 class="section-title">Rozszerzona Rzeczywistość (AR)</h2>
                <div class="panel-card">
                    <p>Panel sterowania znacznikami AR i podgląd z kamery (jeśli dostępny).</p>
                    <div class="alert alert-warning">
                        Funkcjonalność AR wymaga dostępu do kamery oraz konfiguracji OpenCV na serwerze.
                    </div>
                    <!-- Miejsce na strumień wideo lub kontrolki AR -->
                </div>
            </div>

            <!-- SEKCJE: PYTANIA RUNDA 1, 2, 3 -->
            {% for round_id in ['r1', 'r2', 'r3'] %}
            <div id="pytania-{{ round_id }}" class="content-section">
                <h2 class="section-title">Pytania: Runda {{ round_id[-1] }}</h2>

                <!-- Kontener pytań - zachowujemy pętle Jinja2 -->
                <div id="questions-{{ round_id }}-container">
                    {% set questions = questions_r1 if round_id == 'r1' else (questions_r2 if round_id == 'r2' else questions_r3) %}

                    {% for q in questions %}
                    <div class="question-item" id="q-{{ round_id }}-{{ q.id }}">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <h5 class="mb-2"><span class="badge bg-secondary me-2">#{{ loop.index }}</span> {{ q.question_text }}</h5>
                                {% if round_id == 'r1' %}
                                <div class="d-flex flex-wrap gap-2 mb-2">
                                    <span class="badge bg-light text-dark border">A: {{ q.option_a }}</span>
                                    <span class="badge bg-light text-dark border">B: {{ q.option_b }}</span>
                                    <span class="badge bg-light text-dark border">C: {{ q.option_c }}</span>
                                    <span class="badge bg-light text-dark border">D: {{ q.option_d }}</span>
                                </div>
                                {% endif %}
                                <div class="small text-muted">
                                    Prawidłowa: <strong>{{ q.correct_answer }}</strong>
                                    {% if q.time_limit %}| Czas: {{ q.time_limit }}s{% endif %}
                                </div>
                            </div>

                            <div class="d-flex flex-column gap-2 ms-3" style="min-width: 120px;">
                                <button class="btn btn-sm btn-primary activate-q-btn" data-qid="{{ q.id }}" data-type="{{ round_id }}">
                                    <i class="bi bi-play-fill"></i> Aktywuj
                                </button>

                                {% if round_id == 'r1' %}
                                <button class="btn btn-sm btn-outline-secondary reveal-q-btn" data-qid="{{ q.id }}" disabled>
                                    <i class="bi bi-eye"></i> Pokaż odp.
                                </button>
                                <button class="btn btn-sm btn-outline-danger close-q-btn" data-qid="{{ q.id }}" disabled>
                                    <i class="bi bi-x-circle"></i> Zakończ
                                </button>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Pasek postępu (tylko R1) -->
                        {% if round_id == 'r1' %}
                        <div class="mt-3">
                            <div class="progress" style="height: 6px;">
                                <div class="progress-bar bg-success" id="progress-q-{{ q.id }}" role="progressbar" style="width: 0%"></div>
                            </div>
                            <div class="d-flex justify-content-between small text-muted mt-1">
                                <span id="answers-count-{{ q.id }}">Odpowiedzi: 0</span>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    {% else %}
                    <div class="alert alert-light text-center">Brak pytań w tej rundzie.</div>
                    {% endfor %}
                </div>
            </div>
            {% endfor %}

            <!-- POZOSTAŁE SEKCJE (AI, Minigry, etc.) -->
            <div id="ai" class="content-section">
                <h2 class="section-title">Generator AI</h2>
                <div class="panel-card">
                    <label class="form-label">Temat pytań</label>
                    <div class="input-group mb-3">
                        <input type="text" class="form-control" placeholder="np. Historia kina polskiego">
                        <button class="btn btn-primary">Generuj</button>
                    </div>
                    <p class="text-muted small">Wymaga aktywnego klucza API w konfiguracji.</p>
                </div>
            </div>

            <div id="wrozka" class="content-section">
                <h2 class="section-title">Wróżka AI</h2>
                <div class="panel-card text-center py-5">
                    <i class="bi bi-stars text-warning display-1 mb-3"></i>
                    <h4>Panel Wróżki</h4>
                    <p>Tutaj pojawią się pytania od graczy do wróżki.</p>
                </div>
            </div>

            <div id="minigry" class="content-section">
                <h2 class="section-title">Minigry</h2>
                <div class="row">
                    <div class="col-md-4">
                        <div class="panel-card text-center">
                            <i class="bi bi-pie-chart fs-1 text-primary mb-3"></i>
                            <h5>Koło Fortuny</h5>
                            <button class="btn btn-sm btn-outline-primary mt-2">Uruchom</button>
                        </div>
                    </div>
                    <!-- Miejsce na więcej minigier -->
                </div>
            </div>

            <div id="foto" class="content-section">
                <h2 class="section-title">Foto Galeria</h2>
                <div class="panel-card">
                    <div class="alert alert-secondary text-center">Brak zdjęć w tej sesji.</div>
                </div>
            </div>

            <div id="glosowanie" class="content-section">
                <h2 class="section-title">Głosowanie</h2>
                <div class="panel-card">
                    <button class="btn btn-primary"><i class="bi bi-plus-circle"></i> Nowe Głosowanie</button>
                </div>
            </div>

            <div id="na-zywo" class="content-section">
                <h2 class="section-title">Podgląd Na Żywo (Logi)</h2>
                <div class="bg-dark text-light p-3 rounded font-monospace" id="live-logs" style="height: 400px; overflow-y: auto; font-size: 0.85rem;">
                    <div class="text-success">> System initialized...</div>
                    <div class="text-muted">> Waiting for connection...</div>
                </div>
            </div>

        </div>
    </main>
</div>

<!-- Przycisk Menu Mobilnego -->
<button id="mobile-menu-toggle" class="btn btn-primary" onclick="toggleMobileMenu()">
    <i class="bi bi-list"></i>
</button>

{% endblock %}

{% block scripts %}
{{ super() }}
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
<script>
    // --- 1. NAWIGACJA I UI ---
    function showSection(sectionId, element) {
        // Ukryj wszystkie sekcje
        document.querySelectorAll('.content-section').forEach(el => el.classList.remove('active'));
        // Pokaż wybraną
        const target = document.getElementById(sectionId);
        if (target) target.classList.add('active');

        // Aktualizuj menu
        document.querySelectorAll('.sidebar-link').forEach(el => el.classList.remove('active'));
        if (element) element.classList.add('active');

        // Zamknij menu na mobile
        if (window.innerWidth <= 992) {
            toggleMobileMenu();
        }
    }

    function toggleMobileMenu() {
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('sidebar-overlay');
        sidebar.classList.toggle('open');
        overlay.classList.toggle('visible');
    }

    function copyLink() {
        const el = document.createElement('textarea');
        el.value = "{{ url_for('player_join', event_id=event.id, _external=True) }}";
        document.body.appendChild(el);
        el.select();
        document.execCommand('copy');
        document.body.removeChild(el);
        alert('Skopiowano link do schowka!');
    }

    // --- 2. LOGIKA GRY (SOCKET.IO & TIMERY) ---
    const socket = io();
    const eventId = "{{ event.id }}";

    let gameTimerInterval, r2TimerInterval, r3TimerInterval;
    let gameStartTime = null, totalPausedDuration = 0, isPaused = false;
    let r2TimerEndTime = null, r3TimerEndTime = null;

    // Połączenie z pokojem
    socket.on('connect', () => {
        console.log('Connected to Socket.IO');
        socket.emit('join', { room: eventId });
        logAction('Połączono z serwerem.');
    });

    // Aktualizacja statusu gry
    socket.on('game_status_update', (data) => {
        updateGameStatusUI(data);
    });

    // Aktualizacja listy graczy
    socket.on('players_update', (players) => {
        renderPlayersTable(players);
    });

    // Logi w panelu
    function logAction(msg) {
        const logs = document.getElementById('live-logs');
        const div = document.createElement('div');
        div.textContent = `> ${new Date().toLocaleTimeString()} ${msg}`;
        logs.prepend(div);
    }

    function updateGameStatusUI(data) {
        const statusEl = document.getElementById('info-game-status');
        const startBtn = document.getElementById('start-game-btn');
        const pauseBtn = document.getElementById('pause-game-btn');
        const stopBtn = document.getElementById('stop-game-btn');
        const badge = document.getElementById('active-round-badge');

        // Status Tekstowy
        if (data.status === 'active') {
            statusEl.innerHTML = '<span class="status-indicator status-active"></span>Gra Aktywna';
            startBtn.style.display = 'none';
            pauseBtn.style.display = 'inline-block';
            pauseBtn.innerHTML = '<i class="bi bi-pause-fill"></i> PAUZA';
            stopBtn.style.display = 'inline-block';
            isPaused = false;

            if (data.start_time) {
                gameStartTime = new Date(data.start_time);
                totalPausedDuration = (data.total_paused_seconds || 0) * 1000;
                if (!gameTimerInterval) gameTimerInterval = setInterval(updateMainTimer, 1000);
            }
        } else if (data.status === 'paused') {
            statusEl.innerHTML = '<span class="status-indicator status-paused"></span>Pauza';
            pauseBtn.innerHTML = '<i class="bi bi-play-fill"></i> WZNÓW';
            isPaused = true;
        } else {
            statusEl.innerHTML = '<span class="status-indicator status-waiting"></span>Oczekiwanie';
            startBtn.style.display = 'inline-block';
            pauseBtn.style.display = 'none';
            stopBtn.style.display = 'none';
            clearInterval(gameTimerInterval);
            gameTimerInterval = null;
        }

        // Badge Rundy
        if (data.active_round) {
            badge.textContent = `Runda ${data.active_round}`;
            badge.className = 'badge bg-primary text-white border p-2';
        }
    }

    function updateMainTimer() {
        if (!gameStartTime || isPaused) return;
        const now = new Date();
        const diff = now - gameStartTime - totalPausedDuration;
        if (diff < 0) return;

        const h = Math.floor(diff / 3600000).toString().padStart(2, '0');
        const m = Math.floor((diff % 3600000) / 60000).toString().padStart(2, '0');
        const s = Math.floor((diff % 60000) / 1000).toString().padStart(2, '0');

        document.getElementById('info-time-elapsed').textContent = `${h}:${m}:${s}`;
    }

    // Przyciski sterowania grą
    document.getElementById('start-game-btn').onclick = () => fetch(`/api/host/game/start/${eventId}`, { method: 'POST' });
    document.getElementById('pause-game-btn').onclick = () => {
        const endpoint = isPaused ? 'resume' : 'pause';
        fetch(`/api/host/game/${endpoint}/${eventId}`, { method: 'POST' });
    };
    document.getElementById('stop-game-btn').onclick = () => {
        if(confirm('Zakończyć grę?')) fetch(`/api/host/game/stop/${eventId}`, { method: 'POST' });
    };

    // --- 3. OBSŁUGA GRACZY ---
    function renderPlayersTable(players) {
        const tbody = document.getElementById('players-table-body');
        tbody.innerHTML = '';
        // Sortowanie wg punktów malejąco
        players.sort((a, b) => b.score - a.score);

        players.forEach((p, index) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><span class="badge bg-light text-dark border rounded-pill">#${index + 1}</span></td>
                <td>
                    <div class="fw-bold">${p.name}</div>
                </td>
                <td class="text-muted small">${p.id.substring(0, 6)}...</td>
                <td class="text-end fw-bold text-primary">${p.score} pkt</td>
                <td class="text-center">
                    <button class="btn btn-sm btn-outline-danger" onclick="kickPlayer('${p.id}')" title="Wyrzuć">
                        <i class="bi bi-x-lg"></i>
                    </button>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    window.kickPlayer = (pid) => {
        if(confirm('Czy na pewno usunąć tego gracza?')) {
            // Tutaj logika fetch do usunięcia gracza
            console.log('Kick player:', pid);
        }
    };

    // --- 4. OBSŁUGA PYTAŃ (R1, R2, R3) ---
    document.querySelectorAll('.activate-q-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const qid = this.dataset.qid;
            const type = this.dataset.type; // r1, r2, r3

            // Wywołanie API
            fetch(`/api/host/question/activate/${eventId}/${qid}`, { method: 'POST' })
                .then(r => r.json())
                .then(res => {
                    if(res.status === 'success') {
                        logAction(`Aktywowano pytanie ${qid} (${type})`);

                        // UI Update dla R1
                        if(type === 'r1') {
                            const parent = document.getElementById(`q-r1-${qid}`);
                            // Resetuj inne aktywne
                            document.querySelectorAll('.question-item').forEach(qi => qi.classList.remove('active-q'));
                            parent.classList.add('active-q');

                            parent.querySelector('.activate-q-btn').disabled = true;
                            parent.querySelector('.reveal-q-btn').disabled = false;
                            parent.querySelector('.close-q-btn').disabled = false;
                        }
                    }
                });
        });
    });

    // Obsługa Reveal / Close dla R1 (przykład)
    document.querySelectorAll('.reveal-q-btn').forEach(btn => {
        btn.onclick = function() {
            const qid = this.dataset.qid;
            fetch(`/api/host/question/reveal/${eventId}/${qid}`, { method: 'POST' });
        }
    });

    // --- 5. OBSŁUGA TIMERÓW R2 i R3 ---
    function handleRoundTimer(roundPrefix, displayId, inputId, startBtnId, cancelBtnId) {
        let intervalVar;

        function updateDisplay(endTime) {
            const now = new Date();
            const left = Math.ceil((endTime - now) / 1000);
            const display = document.getElementById(displayId);

            if (left <= 0) {
                display.textContent = "00:00";
                display.classList.add('bg-danger', 'text-white');
                clearInterval(intervalVar);
                return;
            }

            const m = Math.floor(left / 60).toString().padStart(2, '0');
            const s = (left % 60).toString().padStart(2, '0');
            display.textContent = `${m}:${s}`;
        }

        document.getElementById(startBtnId).onclick = () => {
            const min = document.getElementById(inputId).value;
            // Symulacja API Call
            fetch(`/api/host/questions_${roundPrefix}/timer/start/${eventId}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({minutes: min})
            }).then(r => r.json()).then(data => {
                if(data.end_time) {
                    const endTime = new Date(data.end_time);
                    document.getElementById(displayId).style.display = 'block';
                    document.getElementById(cancelBtnId).style.display = 'inline-block';

                    if(intervalVar) clearInterval(intervalVar);
                    intervalVar = setInterval(() => updateDisplay(endTime), 1000);
                    updateDisplay(endTime);
                }
            });
        };

        document.getElementById(cancelBtnId).onclick = () => {
            fetch(`/api/host/questions_${roundPrefix}/timer/stop/${eventId}`, { method: 'POST' })
            .then(() => {
                clearInterval(intervalVar);
                document.getElementById(displayId).style.display = 'none';
                document.getElementById(cancelBtnId).style.display = 'none';
            });
        };
    }

    // Inicjalizacja timerów
    handleRoundTimer('r2', 'r2-questions-timer-display', 'r2-questions-timer-minutes', 'r2-questions-timer-start', 'r2-questions-timer-cancel');
    handleRoundTimer('r3', 'r3-questions-timer-display', 'r3-questions-timer-minutes', 'r3-questions-timer-start', 'r3-questions-timer-cancel');

    // --- 6. WYŚWIETLACZ I INNE ---
    window.sendScreenAction = (action) => {
        socket.emit('screen_control', { action: action, room: eventId });
        logAction(`Wysłano komendę ekranu: ${action}`);
    };

    document.getElementById('send-global-message-btn').onclick = () => {
        const msg = document.getElementById('global-message-input').value;
        if(msg) {
            socket.emit('admin_message', { room: eventId, message: msg });
            document.getElementById('global-message-input').value = '';
            alert('Wysłano wiadomość do graczy');
        }
    };

    // Inicjalizacja stanu początkowego (Fetch status)
    fetch(`/api/host/game/status/${eventId}`).then(r=>r.json()).then(data => updateGameStatusUI(data));

</script>
{% endblock %}
